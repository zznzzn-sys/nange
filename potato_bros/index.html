<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ÂúüË±ÜÂÖÑÂºü - 2DËÇâÈ∏ΩÊ∏∏Êàè</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary-color: #ff6b35;
            --secondary-color: #f7931e;
            --accent-color: #4ecdc4;
            --success-color: #45b7d1;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --dark-bg: #1a1a2e;
            --darker-bg: #16213e;
            --light-text: #eee;
            --border-radius: 12px;
            --shadow-light: 0 4px 15px rgba(255, 107, 53, 0.2);
            --shadow-heavy: 0 8px 25px rgba(0, 0, 0, 0.4);
            --gradient-primary: linear-gradient(135deg, #ff6b35, #f7931e);
            --gradient-secondary: linear-gradient(135deg, #4ecdc4, #45b7d1);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: var(--light-text);
            font-family: 'Rajdhani', sans-serif;
            overflow: hidden;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255, 107, 53, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(78, 205, 196, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(247, 147, 30, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        #game-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #gameCanvas {
            border: 3px solid;
            border-image: var(--gradient-primary) 1;
            background-color: #000000;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-heavy);
        }

        .loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .loading-text {
            font-family: 'Orbitron', monospace;
            font-size: 28px;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 30px;
            text-shadow: 0 0 20px rgba(255, 107, 53, 0.5);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .game-ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .status-bar {
            position: absolute;
            top: 20px;
            left: 20px;
            min-width: 280px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            padding: 20px;
            border-radius: var(--border-radius);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-light);
            z-index: 100;
            transition: all 0.3s ease;
        }

        .player-stats-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            min-width: 280px;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            padding: 15px;
            border-radius: var(--border-radius);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-light);
            z-index: 100;
            transition: all 0.3s ease;
        }

        .player-stats-panel:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.3);
        }

        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--glass-border);
        }

        .stats-title {
            font-family: 'Orbitron', monospace;
            font-size: 14px;
            font-weight: 700;
            color: var(--light-text);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 6px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }

        .stat-icon {
            font-size: 16px;
            margin-bottom: 3px;
        }

        .stat-label {
            font-size: 10px;
            color: var(--secondary-color);
            font-weight: 500;
            margin-bottom: 2px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-family: 'Orbitron', monospace;
            font-size: 12px;
            font-weight: 700;
            color: var(--light-text);
        }

        .status-bar:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.3);
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .status-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--secondary-color);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-value {
            font-family: 'Orbitron', monospace;
            font-size: 16px;
            font-weight: 700;
            color: var(--light-text);
        }

        .health-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .health-bar {
            width: 200px;
            height: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
        }

        .health-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.2), transparent);
            border-radius: 6px 6px 0 0;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c 0%, #c0392b 50%, #e74c3c 100%);
            transition: width 0.5s ease;
            border-radius: 6px;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.3);
        }

        .health-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.3) 50%, transparent 100%);
            animation: shimmer 2s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* ÊâãÊú∫Á´ØËß¶Êë∏ÊéßÂà∂Ê†∑Âºè */
        .mobile-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 180px;
            display: none;
            pointer-events: auto;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .joystick-container {
            position: absolute;
            bottom: 30px;
            left: 30px;
            width: 120px;
            height: 120px;
        }
        
        .joystick {
            width: 100px;
            height: 100px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            position: relative;
            border: 2px solid var(--glass-border);
            box-shadow: var(--shadow-light);
            transition: all 0.3s ease;
        }
        
        .joystick::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 60%;
            height: 60%;
            border: 1px dashed rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        
        .joystick-handle {
            width: 55px;
            height: 55px;
            background: var(--gradient-primary);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: transform 0.1s ease;
            box-shadow: 0 4px 20px rgba(255, 107, 53, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.4);
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        
        .joystick-handle::after {
            content: '';
            position: absolute;
            top: 20%;
            left: 20%;
            width: 60%;
            height: 60%;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
        }
        
        .action-buttons {
            position: absolute;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .action-btn {
            width: 95px;
            height: 95px;
            border-radius: 50%;
            border: none;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            color: white;
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            touch-action: manipulation;
            border: 2px solid var(--glass-border);
            box-shadow: var(--shadow-light);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            -webkit-tap-highlight-color: transparent;
        }
        
        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-secondary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .action-btn:active {
            transform: scale(0.9);
            box-shadow: 0 0 25px rgba(78, 205, 196, 0.6);
        }
        
        /* ÁßªÂä®Á´ØËß¶Êë∏ÂèçÈ¶à‰ºòÂåñ */
        .action-btn.touch-active {
            transform: scale(0.85);
            box-shadow: 0 0 30px rgba(78, 205, 196, 0.8);
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }
        
        .action-btn:active::before {
            opacity: 0.6;
        }
        
        /* Ê∑ªÂä†Ëß¶Êë∏Ê∂üÊº™ÊïàÊûú */
        .action-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.4s ease;
        }
        
        .action-btn:active::after {
            width: 120px;
            height: 120px;
            opacity: 0;
        }
        
        .shop-btn {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(56, 142, 60, 0.3));
        }
        
        .shop-btn::before {
            background: var(--gradient-secondary);
        }
        
        .pause-btn {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.3), rgba(211, 47, 47, 0.3));
        }
        
        .pause-btn::before {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .action-btn span {
            position: relative;
            z-index: 2;
        }
        
        /* Ê≥¢Ê¨°ËÆ°Êó∂Âô®Ê†∑Âºè */
        #waveTimer {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            padding: 12px 24px;
            border-radius: var(--border-radius);
            font-family: 'Orbitron', monospace;
            font-size: 18px;
            font-weight: 600;
            color: var(--light-text);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-light);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        #waveTimer:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(-50%) translateY(-2px);
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            #game-container {
                width: 100vw;
                height: 100vh;
                padding: 0;
                margin: 0;
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
                overflow: hidden;
            }
            
            /* ÁßªÂä®Á´ØËß¶Êë∏ÊèêÁ§∫ */
            .mobile-tutorial {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.95);
                color: white;
                padding: 30px;
                border-radius: 15px;
                text-align: center;
                z-index: 9999;
                max-width: 320px;
                display: none;
                backdrop-filter: blur(10px);
                border: 2px solid rgba(255, 255, 255, 0.2);
                animation: tutorialSlideIn 0.5s ease-out;
            }
            
            @keyframes tutorialSlideIn {
                from {
                    opacity: 0;
                    transform: translate(-50%, -60%);
                }
                to {
                    opacity: 1;
                    transform: translate(-50%, -50%);
                }
            }
            
            .mobile-tutorial h3 {
                color: #ff9800;
                margin-bottom: 20px;
                font-size: 22px;
                font-weight: bold;
            }
            
            .mobile-tutorial p {
                margin: 12px 0;
                text-align: left;
                font-size: 15px;
                line-height: 1.4;
            }
            
            .mobile-tutorial button {
                background: linear-gradient(135deg, #ff9800, #ff5722);
                border: none;
                padding: 14px 28px;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                cursor: pointer;
                font-size: 16px;
                margin-top: 15px;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
            }
            
            .mobile-tutorial button:hover {
                background: linear-gradient(135deg, #ff5722, #ff9800);
                transform: scale(1.05);
                box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
            }
            
            .mobile-tutorial button:active {
                transform: scale(0.95);
            }
            
            #gameCanvas {
                width: 100%;
                height: 100%;
                border: 2px solid;
                border-image: var(--gradient-primary) 1;
                border-radius: 0;
                object-fit: cover;
            }
            
            .status-bar {
                top: 15px;
                left: 15px;
                min-width: auto;
                flex-direction: row;
                flex-wrap: wrap;
                gap: 15px;
                padding: 15px;
            }
            
            .status-item {
                flex-direction: column;
                align-items: center;
                min-width: 80px;
            }
            
            .health-container {
                flex-direction: column;
                align-items: center;
            }
            
            .health-bar {
                width: 120px;
                height: 10px;
            }
            
            .status-label {
                font-size: 12px;
            }
            
            .status-value {
                font-size: 14px;
            }
            
            .player-stats-panel {
                bottom: 200px;
                left: 15px;
                right: 15px;
                min-width: auto;
                padding: 12px;
            }
            
            .stats-title {
                font-size: 12px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .stat-item {
                padding: 5px;
            }
            
            .stat-icon {
                font-size: 14px;
            }
            
            .stat-label {
                font-size: 9px;
            }
            
            .stat-value {
                font-size: 11px;
            }
            
            .mobile-controls {
                display: flex;
                height: 200px;
            }
            
            /* ÁßªÂä®Á´Ø‰ºòÂåñÔºöÈò≤Ê≠¢È°µÈù¢ÊªöÂä® */
            body {
                overflow: hidden;
                position: fixed;
                width: 100%;
                height: 100%;
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: none;
            }
            
            #waveTimer {
                bottom: 220px;
                font-size: 16px;
                padding: 10px 20px;
            }
        }
        
        @media (max-width: 480px) {
            .status-bar {
                top: 10px;
                left: 10px;
                padding: 12px;
                gap: 12px;
            }
            
            .status-item {
                min-width: 70px;
            }
            
            .health-bar {
                width: 100px;
                height: 8px;
            }
            
            .status-label {
                font-size: 11px;
            }
            
            .status-value {
                font-size: 13px;
            }
            
            .player-stats-panel {
                bottom: 180px;
                left: 10px;
                right: 10px;
                padding: 10px;
            }
            
            .stats-title {
                font-size: 11px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }
            
            .stat-item {
                padding: 4px;
            }
            
            .stat-icon {
                font-size: 12px;
            }
            
            .stat-label {
                font-size: 8px;
            }
            
            .stat-value {
                font-size: 10px;
            }
            
            .joystick-container {
                bottom: 20px;
                left: 20px;
                width: 100px;
                height: 100px;
            }
            
            .joystick {
                width: 85px;
                height: 85px;
            }
            
            .joystick-handle {
                width: 45px;
                height: 45px;
            }
            
            .action-buttons {
                bottom: 20px;
                right: 20px;
                gap: 15px;
            }
            
            .action-btn {
                width: 80px;
                height: 80px;
                font-size: 14px;
            }
            
            #waveTimer {
                bottom: 200px;
                font-size: 14px;
                padding: 8px 16px;
            }
        }

        /* Âä®ÁîªÊïàÊûú */
        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInFromLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInFromBottom {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status-bar {
            animation: slideInFromLeft 0.6s ease-out;
        }

        .mobile-controls {
            animation: slideInFromBottom 0.6s ease-out;
        }

        #waveTimer {
            animation: slideInFromTop 0.6s ease-out;
        }

        /* ÁâπÊÆäÊïàÊûú */
        .glow-effect {
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from {
                box-shadow: var(--shadow-light);
            }
            to {
                box-shadow: 0 0 25px rgba(255, 107, 53, 0.6);
            }
        }

        /* ‰ΩéÁîüÂëΩÂÄºË≠¶ÂëäÊïàÊûú */
        .health-fill.low-health {
            background: linear-gradient(90deg, #e74c3c 0%, #ff6b6b 50%, #e74c3c 100%);
            animation: healthWarning 1s ease-in-out infinite;
        }

        @keyframes healthWarning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* ‰ºòÂåñÂïÜÂ∫óÁïåÈù¢ */
        .shop-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(15px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .shop-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .shop-container {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid var(--glass-border);
            border-radius: 20px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            box-shadow: var(--shadow-heavy);
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .shop-overlay.active .shop-container {
            transform: translateY(0);
        }

        .shop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--glass-border);
        }

        .shop-title {
            font-family: 'Orbitron', monospace;
            font-size: 32px;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(255, 107, 53, 0.3);
        }

        .shop-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .money-display {
            font-family: 'Orbitron', monospace;
            font-size: 24px;
            font-weight: 700;
            color: #4caf50;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .wave-info {
            font-size: 18px;
            color: var(--accent-color);
            font-weight: 600;
        }

        .close-shop {
            background: var(--gradient-primary);
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            color: white;
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-light);
        }

        .close-shop:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.4);
        }

        .shop-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .shop-item {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .shop-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .shop-item:hover::before {
            left: 100%;
        }

        .shop-item:hover {
            transform: translateY(-5px);
            border-color: var(--primary-color);
            box-shadow: var(--shadow-light);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .item-name {
            font-size: 20px;
            font-weight: 700;
            color: var(--light-text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .item-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .item-price {
            font-family: 'Orbitron', monospace;
            font-size: 22px;
            font-weight: 700;
            color: #4caf50;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .item-description {
            font-size: 14px;
            color: #aaa;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .item-stats {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .stat-tag {
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: var(--accent-color);
        }

        .buy-button {
            width: 100%;
            background: var(--gradient-secondary);
            border: none;
            border-radius: 12px;
            padding: 12px;
            color: white;
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .buy-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .buy-button:hover::before {
            left: 100%;
        }

        .buy-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(78, 205, 196, 0.4);
        }

        .buy-button:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .shop-items-grid::-webkit-scrollbar {
            width: 8px;
        }

        .shop-items-grid::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .shop-items-grid::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        .shop-items-grid::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }

        /* ‰ºòÂåñÊöÇÂÅúÁïåÈù¢ */
        .pause-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .pause-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .pause-container {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid var(--glass-border);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow-heavy);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .pause-overlay.active .pause-container {
            transform: scale(1);
        }

        .pause-title {
            font-family: 'Orbitron', monospace;
            font-size: 42px;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 30px;
            text-shadow: 0 0 20px rgba(255, 107, 53, 0.3);
        }

        .pause-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
            background: var(--glass-bg);
            border-radius: 12px;
            padding: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-family: 'Orbitron', monospace;
            font-size: 24px;
            font-weight: 700;
            color: var(--light-text);
        }

        .pause-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .pause-button {
            flex: 1;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 15px 25px;
            color: var(--light-text);
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pause-button:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }

        .resume-button {
            background: var(--gradient-primary);
            border: none;
            color: white;
        }

        .resume-button:hover {
            background: var(--gradient-primary);
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.4);
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <!-- Ê≥¢Ê¨°ÂÄíËÆ°Êó∂ÊòæÁ§∫ -->
        <div id="waveTimer">‚è∞ Ê≥¢Ê¨°Ââ©‰ΩôÊó∂Èó¥: 02:00</div>
    </div>
    
    <div class="game-ui">
        <div class="status-bar">
            <div class="status-item">
                <div class="status-label">üíö ÁîüÂëΩÂÄº</div>
                <div class="health-container">
                    <div class="health-bar">
                        <div id="health-fill" class="health-fill" style="width: 100%;"></div>
                    </div>
                    <div class="status-value" id="health-value">100/100</div>
                </div>
            </div>
            
            <div class="status-item">
                <div class="status-label">üí∞ ÈáëÈí±</div>
                <div class="status-value" id="money-value">0</div>
            </div>
            
            <div class="status-item">
                <div class="status-label">üëπ Êïå‰∫∫</div>
                <div class="status-value" id="enemies-count">0</div>
            </div>
            
            <div class="status-item">
                <div class="status-label">üèÜ ÂàÜÊï∞</div>
                <div class="status-value" id="score-value">0</div>
            </div>
        </div>
        
        <!-- Áé©ÂÆ∂Â±ûÊÄßË°® - ÊîæÂú®Â±èÂπïÂ∑¶‰∏ãËßí -->
        <div id="player-stats-panel" class="player-stats-panel">
            <div class="stats-header">
                <div class="stats-title">üéÆ Áé©ÂÆ∂Â±ûÊÄß</div>
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-icon">‚öîÔ∏è</div>
                    <div class="stat-label">ÊîªÂáªÂäõ</div>
                    <div id="stat-damage" class="stat-value">10</div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon">‚ö°</div>
                    <div class="stat-label">ÊîªÈÄü</div>
                    <div id="stat-attack-speed" class="stat-value">0.7/Áßí</div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon">üéØ</div>
                    <div class="stat-label">ÂºπÈÅìÊï∞</div>
                    <div id="stat-projectiles" class="stat-value">1</div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon">üí•</div>
                    <div class="stat-label">ÁàÜÁÇ∏ÂçäÂæÑ</div>
                    <div id="stat-explosion-radius" class="stat-value">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon">üèÉ</div>
                    <div class="stat-label">ÁßªÂä®ÈÄüÂ∫¶</div>
                    <div id="stat-speed" class="stat-value">3</div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-label">ÈáëÈí±Âä†Êàê</div>
                    <div id="stat-money-bonus" class="stat-value">+0%</div>
                </div>
            </div>
        </div>
        
        <!-- ÊâãÊú∫Á´ØËß¶Êë∏ÊéßÂà∂ -->
        <div id="mobile-controls" class="mobile-controls">
            <div class="joystick-container">
                <div id="joystick" class="joystick">
                    <div class="joystick-handle"></div>
                </div>
            </div>
            <div class="action-buttons">
                <button id="shop-btn" class="action-btn shop-btn">
                    <span>üõí<br>ÂïÜÂ∫ó</span>
                </button>
                <button id="pause-btn" class="action-btn pause-btn">
                    <span>‚è∏Ô∏è<br>ÊöÇÂÅú</span>
                </button>
            </div>
        </div>
    </div>
    
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-text">Âä†ËΩΩÂúüË±ÜÂÖÑÂºüÊ∏∏Êàè...</div>
    </div>
    
    <!-- ÂïÜÂ∫óÁïåÈù¢ -->
    <div id="shop-overlay" class="shop-overlay">
        <div class="shop-container">
            <div class="shop-header">
                <h2 class="shop-title">üõí ÂúüË±ÜÂïÜÂ∫ó</h2>
                <div class="shop-info">
                    <div class="money-display">üí∞ <span id="shop-money">0</span></div>
                    <div class="wave-info">üåä Á¨¨<span id="shop-wave">1</span>Ê≥¢</div>
                </div>
                <button id="close-shop" class="close-shop">üöÄ ÁªßÁª≠Ê∏∏Êàè</button>
            </div>
            <div id="shop-items-grid" class="shop-items-grid">
                <!-- ÂïÜÂ∫óÁâ©ÂìÅÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
            </div>
        </div>
    </div>
    
    <!-- ÊöÇÂÅúÁïåÈù¢ -->
    <div id="pause-overlay" class="pause-overlay">
        <div class="pause-container">
            <h2 class="pause-title">‚è∏Ô∏è Ê∏∏ÊàèÊöÇÂÅú</h2>
            <div class="pause-stats">
                <div class="stat-item">
                    <div class="stat-label">ÂΩìÂâçÊ≥¢Ê¨°</div>
                    <div id="pause-wave" class="stat-value">1</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ÂáªÊùÄÊïå‰∫∫</div>
                    <div id="pause-kills" class="stat-value">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ÂΩìÂâçÂàÜÊï∞</div>
                    <div id="pause-score" class="stat-value">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Ê∏∏ÊàèÊó∂Èó¥</div>
                    <div id="pause-time" class="stat-value">00:00</div>
                </div>
            </div>
            <div class="pause-buttons">
                <button id="resume-game" class="pause-button resume-button">‚ñ∂Ô∏è ÁªßÁª≠Ê∏∏Êàè</button>
                <button id="restart-game" class="pause-button">üîÑ ÈáçÊñ∞ÂºÄÂßã</button>
            </div>
        </div>
    </div>
    
    <script>
        // ÂúüË±ÜÂÖÑÂºüÊ∏∏Êàè - ÁÆÄÂåñÁâà
        // Ë∞ÉËØïÊ®°ÂºèÂºÄÂÖ≥
        window.DEBUG_MODE = false;
        
        document.addEventListener('DOMContentLoaded', () => {
            // Ëé∑ÂèñÁîªÂ∏ÉÂíå‰∏ä‰∏ãÊñá
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            
            // ÁßªÂä®Á´ØÁîªÂ∏É‰ºòÂåñ
            if (window.innerWidth <= 768) {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            
            // Ëé∑ÂèñUIÂÖÉÁ¥†
            const healthFill = document.getElementById('health-fill');
            const healthValue = document.getElementById('health-value');
            const moneyValue = document.getElementById('money-value');
            const enemiesCount = document.getElementById('enemies-count');
            const scoreValue = document.getElementById('score-value');
            
            // Ê∏∏ÊàèÁä∂ÊÄÅ
            let gameState = 'start'; // start, playing, paused, gameOver, shop
            let frameCount = 0; // Â∏ßÊï∞ËÆ°Êï∞Âô®ÔºåÁî®‰∫éË∞ÉËØï
            
            // ÂïÜÂ∫óÁõ∏ÂÖ≥
            const shopItems = [
                { id: 1, name: '‰º§ÂÆ≥ÊèêÂçá', description: 'ÊîªÂáªÂäõ +5', price: 50, type: 'damage', value: 5 },
                { id: 2, name: 'ÁîüÂëΩÊÅ¢Â§ç', description: 'ÁîüÂëΩÂÄº +20', price: 30, type: 'health', value: 20 },
                { id: 3, name: 'Â∞ÑÈÄüÊèêÂçá', description: 'ÊîªÂáªÈÄüÂ∫¶ +20%', price: 80, type: 'fireRate', value: -0.2 },
                { id: 4, name: 'ÁßªÂä®Âä†ÈÄü', description: 'ÁßªÂä®ÈÄüÂ∫¶ +0.5', price: 40, type: 'speed', value: 0.5 },
                { id: 5, name: 'ÂèåÂºπÈÅì', description: 'Â¢ûÂä†‰∏Ä‰∏™ÂºπÈÅì', price: 150, type: 'projectiles', value: 1 },
                { id: 6, name: 'ËåÉÂõ¥ÊîªÂáª', description: 'Â≠êÂºπÁàÜÁÇ∏ËåÉÂõ¥ +10', price: 120, type: 'explosionRadius', value: 10 },
                { id: 7, name: 'ÁîüÂëΩ‰∏äÈôê', description: 'ÊúÄÂ§ßÁîüÂëΩÂÄº +10', price: 60, type: 'maxHealth', value: 10 },
                { id: 8, name: 'ÈáëÈí±Âä†Êàê', description: 'ÂáªÊùÄÈáëÈí± +20%', price: 100, type: 'moneyBonus', value: 0.2 }
            ];
            
            // Ê∏∏ÊàèÊï∞ÊçÆ
            const gameData = {
                score: 0,
                money: 0,
                wave: 1,
                difficulty: 1,
                enemiesKilled: 0,
                enemiesPerWave: 4, // Á¨¨‰∏ÄÊ≥¢Êïå‰∫∫Êï∞ÈáèËÆæ‰∏∫4‰∏™
                waveTimer: 0,
                waveTransitionTime: 5000, // Ê≥¢Ê¨°ËΩ¨Êç¢Êó∂Èó¥5Áßí
                waveStartTime: 0, // Ê≥¢Ê¨°ÂºÄÂßãÊó∂Èó¥
                waveDuration: 2 * 60 * 1000 // Ê≥¢Ê¨°ÊåÅÁª≠Êó∂Èó¥(2ÂàÜÈíü)
            };

            let gameStartTime = 0; // Ê∏∏ÊàèÂºÄÂßãÊó∂Èó¥
            
            // Áé©ÂÆ∂ÂØπË±°
            const player = {
                x: canvas.width / 2,
                y: canvas.height / 2,
                width: 30,
                height: 30,
                health: 10,
                maxHealth: 10,
                speed: 3,
                damage: 10,
                fireRate: 1500, // Â¢ûÂä†ÂÜ∑Âç¥Êó∂Èó¥Âà∞1.5ÁßíÔºå‰ΩøÂÖ∂ÊúâÊîªÂáªÈó¥Èöô
                lastShot: 0,
                color: '#4caf50',
                projectiles: 1, // ÂºπÈÅìÊï∞Èáè
                explosionRadius: 0, // ÁàÜÁÇ∏ËåÉÂõ¥
                moneyBonus: 1.0 // ÈáëÈí±Âä†Êàê
            };
            
            // Ê∏∏ÊàèÂØπË±°Êï∞ÁªÑ
            const enemies = [];
            const projectiles = [];
            const particles = [];
            const items = [];
            
            // ËæìÂÖ•ÊéßÂà∂
            const keys = {};
            const mouse = {
                x: 0,
                y: 0
            };
            
            // Ê∏∏ÊàèÁªìÊùüÊåâÈíÆÂå∫Âüü
            let gameOverButton = null;
            
            // ÂºÄÂßãÊåâÈíÆÂå∫Âüü
            let startButton = null;
            
            // ÊâãÊú∫Á´ØËß¶Êë∏ÊéßÂà∂
            let isMobile = false;
            let joystickActive = false;
            let joystickStartX = 0;
            let joystickStartY = 0;
            let joystickCurrentX = 0;
            let joystickCurrentY = 0;
            const joystickRadius = 40;
            
            // ÂèåÂáªÊ£ÄÊµãÂèòÈáè
            let lastTapTime = 0;
            let tapCount = 0;
            const doubleTapDelay = 300; // ÂèåÂáªÈó¥ÈöîÊó∂Èó¥ÔºàÊØ´ÁßíÔºâ
            
            // Ê£ÄÊµãÊòØÂê¶‰∏∫ÁßªÂä®ËÆæÂ§á
            function detectMobile() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                       window.innerWidth <= 768;
            }
            
            // ÂàùÂßãÂåñËß¶Êë∏ÊéßÂà∂
            function initTouchControls() {
                isMobile = detectMobile();
                
                if (isMobile) {
                    console.log('Ê£ÄÊµãÂà∞ÁßªÂä®ËÆæÂ§áÔºåÂêØÁî®Ëß¶Êë∏ÊéßÂà∂');
                    
                    // Ëé∑ÂèñËß¶Êë∏ÊéßÂà∂ÂÖÉÁ¥†
                    const joystick = document.getElementById('joystick');
                    const joystickHandle = document.querySelector('.joystick-handle');
                    const shopBtn = document.getElementById('shop-btn');
                    const pauseBtn = document.getElementById('pause-btn');
                    
                    // ÊëáÊùÜËß¶Êë∏‰∫ã‰ª∂
                    joystick.addEventListener('touchstart', handleJoystickStart);
                    joystick.addEventListener('touchmove', handleJoystickMove);
                    joystick.addEventListener('touchend', handleJoystickEnd);
                    
                    // ÊåâÈíÆËß¶Êë∏‰∫ã‰ª∂
                    shopBtn.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        if (gameState === 'playing') {
                            showShop();
                        } else if (gameState === 'shop') {
                            hideShop();
                        }
                    });
                    
                    pauseBtn.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        if (gameState === 'playing') {
                            showPause();
                        } else if (gameState === 'paused') {
                            hidePause();
                        }
                    });
                }
            }
            
            // ÂàùÂßãÂåñÁßªÂä®Á´Ø‰∫ã‰ª∂
            function initMobileEvents() {
                if (isMobile) {
                    console.log('ÂàùÂßãÂåñÁßªÂä®Á´Ø‰∫ã‰ª∂Â§ÑÁêÜ');
                    
                    // ÊòæÁ§∫ÁßªÂä®ÊéßÂà∂ÁïåÈù¢
                    const mobileControls = document.getElementById('mobile-controls');
                    if (mobileControls) {
                        mobileControls.style.display = 'flex';
                    }
                    
                    // Ê∑ªÂä†Ëß¶Êë∏‰∫ã‰ª∂ÁõëÂê¨Âô®
                    canvas.addEventListener('touchstart', handleCanvasTouchStart);
                    canvas.addEventListener('touchmove', handleCanvasTouchMove);
                    canvas.addEventListener('touchend', handleCanvasTouchEnd);
                    
                    // Èò≤Ê≠¢È°µÈù¢ÊªöÂä®
                    document.addEventListener('touchmove', (e) => {
                        if (e.target === canvas || e.target.closest('.mobile-controls')) {
                            e.preventDefault();
                        }
                    }, { passive: false });
                    
                    // ÂèåÂáªÂºÄÂßãÊ∏∏ÊàèÊ£ÄÊµã
                    canvas.addEventListener('touchstart', handleDoubleTapStartGame);
                    
                    // ‰ºòÂåñÊåâÈíÆËß¶Êë∏ÂèçÈ¶à
                    optimizeButtonTouchFeedback();
                    
                    // ÁßªÂä®Á´ØÊÄßËÉΩ‰ºòÂåñ
                    optimizeMobilePerformance();
                    
                    // Ê∑ªÂä†ÂÖ®Â±èÊîØÊåÅ
                    addFullscreenSupport();
                }
            }
            
            // Ê∑ªÂä†ÂÖ®Â±èÊîØÊåÅ
            function addFullscreenSupport() {
                // ÂàõÂª∫ÂÖ®Â±èÊåâÈíÆ
                const fullscreenBtn = document.createElement('button');
                fullscreenBtn.innerHTML = 'üì±';
                fullscreenBtn.style.cssText = `
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    width: 40px;
                    height: 40px;
                    border: none;
                    border-radius: 50%;
                    background: rgba(255, 255, 255, 0.2);
                    color: white;
                    font-size: 18px;
                    cursor: pointer;
                    z-index: 1001;
                    backdrop-filter: blur(10px);
                    display: none;
                `;
                
                // ÁßªÂä®Á´ØÊòæÁ§∫ÂÖ®Â±èÊåâÈíÆ
                if (isMobile) {
                    fullscreenBtn.style.display = 'block';
                }
                
                fullscreenBtn.addEventListener('click', toggleFullscreen);
                document.body.appendChild(fullscreenBtn);
                
                function toggleFullscreen() {
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen().catch(err => {
                            console.log('ÂÖ®Â±èËØ∑Ê±ÇÂ§±Ë¥•:', err);
                        });
                        fullscreenBtn.innerHTML = 'üì±';
                    } else {
                        if (document.exitFullscreen) {
                            document.exitFullscreen();
                            fullscreenBtn.innerHTML = 'üì±';
                        }
                    }
                }
                
                // ÁõëÂê¨ÂÖ®Â±èÂèòÂåñ
                document.addEventListener('fullscreenchange', () => {
                    fullscreenBtn.innerHTML = document.fullscreenElement ? 'üì±' : 'üì±';
                });
                
                // Ê∑ªÂä†ÁßªÂä®Á´ØÊïôÁ®ã
                addMobileTutorial();
            }
            
            // Ê∑ªÂä†ÁßªÂä®Á´ØÊïôÁ®ã
            function addMobileTutorial() {
                const tutorial = document.createElement('div');
                tutorial.className = 'mobile-tutorial';
                tutorial.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.9);
                    color: white;
                    padding: 30px;
                    border-radius: 15px;
                    text-align: center;
                    z-index: 9999;
                    max-width: 300px;
                    display: none;
                    backdrop-filter: blur(10px);
                    border: 2px solid rgba(255, 255, 255, 0.2);
                `;
                
                tutorial.innerHTML = `
                    <h3 style="margin-bottom: 20px; color: #ff9800;">üéÆ Ê∏∏ÊàèÊìç‰ΩúÊåáÂçó</h3>
                    <div style="text-align: left; margin-bottom: 20px;">
                        <p style="margin: 10px 0;">‚Ä¢ <strong>ÁßªÂä®</strong>: ‰ΩøÁî®Â∑¶‰æßÊëáÊùÜÊéßÂà∂ËßíËâ≤ÁßªÂä®</p>
                        <p style="margin: 10px 0;">‚Ä¢ <strong>ÊîªÂáª</strong>: Ëá™Âä®ÁûÑÂáÜÊúÄËøëÁöÑÊïå‰∫∫</p>
                        <p style="margin: 10px 0;">‚Ä¢ <strong>ÂïÜÂ∫ó</strong>: ÁÇπÂáªÂè≥‰æßÂïÜÂ∫óÊåâÈíÆË¥≠‰π∞ÈÅìÂÖ∑</p>
                        <p style="margin: 10px 0;">‚Ä¢ <strong>ÊöÇÂÅú</strong>: ÁÇπÂáªÊöÇÂÅúÊåâÈíÆÊöÇÂÅúÊ∏∏Êàè</p>
                    </div>
                    <button id="close-tutorial" style="
                        background: #ff9800;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 5px;
                        color: white;
                        font-weight: bold;
                        cursor: pointer;
                    ">ÂºÄÂßãÊ∏∏Êàè</button>
                `;
                
                document.body.appendChild(tutorial);
                
                // ÊòæÁ§∫ÊïôÁ®ãÔºà‰ªÖÈ¶ñÊ¨°Ê∏∏ÊàèÔºâ
                const hasSeenTutorial = localStorage.getItem('potatoBrosTutorialSeen');
                if (!hasSeenTutorial && isMobile) {
                    setTimeout(() => {
                        tutorial.style.display = 'block';
                        localStorage.setItem('potatoBrosTutorialSeen', 'true');
                    }, 1000);
                }
                
                // ÂÖ≥Èó≠ÊïôÁ®ã
                document.getElementById('close-tutorial').addEventListener('click', () => {
                    tutorial.style.display = 'none';
                    if (gameState === 'start') {
                        startGame();
                    }
                });
            }
            
            // ÁßªÂä®Á´ØÊÄßËÉΩ‰ºòÂåñ
            function optimizeMobilePerformance() {
                console.log('Â∫îÁî®ÁßªÂä®Á´ØÊÄßËÉΩ‰ºòÂåñ');
                
                // Èôç‰ΩéÁ≤íÂ≠êÊï∞Èáè‰∏äÈôê
                const originalCreateParticles = createParticles;
                createParticles = function(x, y, color, count) {
                    // ÁßªÂä®Á´ØÂáèÂ∞ëÁ≤íÂ≠êÊï∞Èáè
                    const mobileCount = Math.min(count, isMobile ? 8 : count);
                    originalCreateParticles.call(this, x, y, color, mobileCount);
                };
                
                // ‰ºòÂåñÊ∏≤ÊüìÊÄßËÉΩ
                const originalRender = render;
                render = function() {
                    // ÁßªÂä®Á´ØÂáèÂ∞ëÊ∏≤ÊüìÁªÜËäÇ
                    if (isMobile) {
                        ctx.imageSmoothingEnabled = false;
                    }
                    originalRender.call(this);
                };
                
                // ÁîµÊ±†‰ºòÂåñÔºöÈôç‰ΩéËÉåÊôØÂä®ÁîªÈ¢ëÁéá
                if (isMobile) {
                    const originalGameLoop = gameLoop;
                    let lastFrameTime = 0;
                    gameLoop = function(timestamp) {
                        // ÈôêÂà∂ÁßªÂä®Á´ØÂ∏ßÁéá
                        if (timestamp - lastFrameTime < 33) { // ~30fps
                            requestAnimationFrame(gameLoop);
                            return;
                        }
                        lastFrameTime = timestamp;
                        originalGameLoop.call(this, timestamp);
                    };
                }
                
                // Â±èÂπïÊñπÂêëÊ£ÄÊµã
                detectScreenOrientation();
            }
            
            // Â±èÂπïÊñπÂêëÊ£ÄÊµã
            function detectScreenOrientation() {
                const orientationMessage = document.createElement('div');
                orientationMessage.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.9);
                    color: white;
                    display: none;
                    justify-content: center;
                    align-items: center;
                    font-size: 24px;
                    text-align: center;
                    z-index: 9999;
                    flex-direction: column;
                `;
                orientationMessage.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 20px;">üì±</div>
                    <div>ËØ∑Â∞ÜËÆæÂ§áÊ®™Â±è‰ª•Ëé∑ÂæóÊúÄ‰Ω≥Ê∏∏Êàè‰ΩìÈ™å</div>
                    <div style="font-size: 16px; margin-top: 20px; opacity: 0.7;">ÊóãËΩ¨ËÆæÂ§áÂêéÂà∑Êñ∞È°µÈù¢</div>
                `;
                document.body.appendChild(orientationMessage);
                
                function checkOrientation() {
                    if (window.innerHeight > window.innerWidth) {
                        // Á´ñÂ±èÊ®°Âºè
                        orientationMessage.style.display = 'flex';
                        canvas.style.display = 'none';
                        document.querySelector('.mobile-controls').style.display = 'none';
                    } else {
                        // Ê®™Â±èÊ®°Âºè
                        orientationMessage.style.display = 'none';
                        canvas.style.display = 'block';
                        if (isMobile) {
                            document.querySelector('.mobile-controls').style.display = 'flex';
                        }
                    }
                }
                
                // ÂàùÂßãÊ£ÄÊµã
                checkOrientation();
                
                // ÁõëÂê¨ÊñπÂêëÂèòÂåñ
                window.addEventListener('resize', checkOrientation);
                window.addEventListener('orientationchange', checkOrientation);
            }
            
            // ‰ºòÂåñÊåâÈíÆËß¶Êë∏ÂèçÈ¶à
            function optimizeButtonTouchFeedback() {
                const buttons = document.querySelectorAll('.action-btn');
                buttons.forEach(button => {
                    button.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        button.classList.add('touch-active');
                    });
                    
                    button.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        button.classList.remove('touch-active');
                    });
                    
                    button.addEventListener('touchcancel', (e) => {
                        e.preventDefault();
                        button.classList.remove('touch-active');
                    });
                });
            }
            
            // ÁîªÂ∏ÉËß¶Êë∏ÂºÄÂßã‰∫ã‰ª∂
            function handleCanvasTouchStart(e) {
                if (!isMobile) return;
                e.preventDefault();
                
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const touchX = touch.clientX - rect.left;
                const touchY = touch.clientY - rect.top;
                
                // Êõ¥Êñ∞Èº†Ê†á‰ΩçÁΩÆÔºàÁî®‰∫éËá™Âä®ÁûÑÂáÜÔºâ
                mouse.x = touchX;
                mouse.y = touchY;
                
                // ÂºÄÂßãÁä∂ÊÄÅ‰∏ãÊ£ÄÊü•ÊåâÈíÆÁÇπÂáª
                if (gameState === 'start' && startButton) {
                    if (touchX >= startButton.x && touchX <= startButton.x + startButton.width &&
                        touchY >= startButton.y && touchY <= startButton.y + startButton.height) {
                        startGame();
                        return;
                    }
                }
                
                // Ê∏∏ÊàèÁªìÊùüÁä∂ÊÄÅ‰∏ãÊ£ÄÊü•ÊåâÈíÆÁÇπÂáª
                if (gameState === 'gameOver' && gameOverButton) {
                    if (touchX >= gameOverButton.x && touchX <= gameOverButton.x + gameOverButton.width &&
                        touchY >= gameOverButton.y && touchY <= gameOverButton.y + gameOverButton.height) {
                        startGame();
                        return;
                    }
                }
                
                if (gameState === 'playing') {
                    // Ëß¶ÂèëÂ∞ÑÂáª
                    if (player.autoAttack) {
                        player.autoAttack = false;
                    } else {
                        player.autoAttack = true;
                    }
                    
                    // Ê∑ªÂä†Ëß¶Êë∏ÂèçÈ¶à
                    createTouchFeedback(touchX, touchY);
                }
            }
            
            // ÂàõÂª∫Ëß¶Êë∏ÂèçÈ¶àÊïàÊûú
            function createTouchFeedback(x, y) {
                // ÂàõÂª∫Ëß¶Êë∏Ê∂üÊº™ÊïàÊûú
                const feedback = document.createElement('div');
                feedback.style.cssText = `
                    position: absolute;
                    left: ${x}px;
                    top: ${y}px;
                    width: 60px;
                    height: 60px;
                    border-radius: 50%;
                    background: rgba(255, 255, 255, 0.3);
                    transform: translate(-50%, -50%) scale(0);
                    pointer-events: none;
                    z-index: 9999;
                    animation: touchRipple 0.6s ease-out forwards;
                `;
                
                // Ê∑ªÂä†Âä®ÁîªÊ†∑Âºè
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes touchRipple {
                        0% {
                            transform: translate(-50%, -50%) scale(0);
                            opacity: 1;
                        }
                        100% {
                            transform: translate(-50%, -50%) scale(2);
                            opacity: 0;
                        }
                    }
                `;
                document.head.appendChild(style);
                
                canvas.parentElement.appendChild(feedback);
                
                // Âä®ÁîªÁªìÊùüÂêéÁßªÈô§ÂÖÉÁ¥†
                setTimeout(() => {
                    if (feedback.parentElement) {
                        feedback.parentElement.removeChild(feedback);
                    }
                    if (style.parentElement) {
                        style.parentElement.removeChild(style);
                    }
                }, 600);
            }
            
            // ÁîªÂ∏ÉËß¶Êë∏ÁßªÂä®‰∫ã‰ª∂
            function handleCanvasTouchMove(e) {
                if (!isMobile || gameState !== 'playing') return;
                e.preventDefault();
                
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                mouse.x = touch.clientX - rect.left;
                mouse.y = touch.clientY - rect.top;
            }
            
            // ÁîªÂ∏ÉËß¶Êë∏ÁªìÊùü‰∫ã‰ª∂
            function handleCanvasTouchEnd(e) {
                if (!isMobile) return;
                e.preventDefault();
                
                // ÂÅúÊ≠¢Ëá™Âä®ÊîªÂáª
                if (gameState === 'playing') {
                    player.autoAttack = false;
                }
            }
            
            // ÊëáÊùÜËß¶Êë∏ÂºÄÂßã
            function handleJoystickStart(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = e.target.getBoundingClientRect();
                
                joystickActive = true;
                joystickStartX = rect.left + rect.width / 2;
                joystickStartY = rect.top + rect.height / 2;
                joystickCurrentX = joystickStartX;
                joystickCurrentY = joystickStartY;
                
                updateJoystickHandle();
            }
            
            // ÊëáÊùÜËß¶Êë∏ÁßªÂä®
            function handleJoystickMove(e) {
                if (!joystickActive) return;
                e.preventDefault();
                
                const touch = e.touches[0];
                joystickCurrentX = touch.clientX;
                joystickCurrentY = touch.clientY;
                
                // ÈôêÂà∂ÊëáÊùÜÁßªÂä®ËåÉÂõ¥
                const dx = joystickCurrentX - joystickStartX;
                const dy = joystickCurrentY - joystickStartY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance > joystickRadius) {
                    const angle = Math.atan2(dy, dx);
                    joystickCurrentX = joystickStartX + Math.cos(angle) * joystickRadius;
                    joystickCurrentY = joystickStartY + Math.sin(angle) * joystickRadius;
                }
                
                updateJoystickHandle();
                updatePlayerMovement();
            }
            
            // ÊëáÊùÜËß¶Êë∏ÁªìÊùü
            function handleJoystickEnd(e) {
                e.preventDefault();
                joystickActive = false;
                
                // ÈáçÁΩÆÊëáÊùÜ‰ΩçÁΩÆ
                joystickCurrentX = joystickStartX;
                joystickCurrentY = joystickStartY;
                
                updateJoystickHandle();
                updatePlayerMovement();
            }
            
            // Êõ¥Êñ∞ÊëáÊùÜÊâãÊüÑ‰ΩçÁΩÆ
            function updateJoystickHandle() {
                const joystickHandle = document.querySelector('.joystick-handle');
                if (joystickHandle) {
                    const dx = joystickCurrentX - joystickStartX;
                    const dy = joystickCurrentY - joystickStartY;
                    joystickHandle.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
                }
            }
            
            // Êõ¥Êñ∞Áé©ÂÆ∂ÁßªÂä®
            function updatePlayerMovement() {
                if (!joystickActive) {
                    // ÈáçÁΩÆÁßªÂä®ÊñπÂêë
                    keys['w'] = false;
                    keys['s'] = false;
                    keys['a'] = false;
                    keys['d'] = false;
                    return;
                }
                
                const dx = joystickCurrentX - joystickStartX;
                const dy = joystickCurrentY - joystickStartY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 10) {
                    // Ë∑ùÁ¶ªÂ§™ËøëÔºåËßÜ‰∏∫ÂÅúÊ≠¢ÁßªÂä®
                    keys['w'] = false;
                    keys['s'] = false;
                    keys['a'] = false;
                    keys['d'] = false;
                    return;
                }
                
                // Ê†πÊçÆÊëáÊùÜÊñπÂêëËÆæÁΩÆÁßªÂä®ÈîÆ
                const angle = Math.atan2(dy, dx);
                const intensity = Math.min(distance / joystickRadius, 1);
                
                // ÈáçÁΩÆÊâÄÊúâÊñπÂêë
                keys['w'] = false;
                keys['s'] = false;
                keys['a'] = false;
                keys['d'] = false;
                
                // ËÆæÁΩÆÁßªÂä®ÊñπÂêëÔºàÂü∫‰∫éËßíÂ∫¶Ôºâ
                if (angle >= -Math.PI/4 && angle < Math.PI/4) {
                    keys['d'] = true; // Âè≥
                } else if (angle >= Math.PI/4 && angle < 3*Math.PI/4) {
                    keys['s'] = true; // ‰∏ã
                } else if (angle >= 3*Math.PI/4 || angle < -3*Math.PI/4) {
                    keys['a'] = true; // Â∑¶
                } else if (angle >= -3*Math.PI/4 && angle < -Math.PI/4) {
                    keys['w'] = true; // ‰∏ä
                }
            }
            
            // ÂèåÂáªÂºÄÂßãÊ∏∏ÊàèÊ£ÄÊµã
            function handleDoubleTapStartGame(e) {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTapTime;
                
                if (tapLength < doubleTapDelay && tapLength > 0) {
                    // Ê£ÄÊµãÂà∞ÂèåÂáª
                    tapCount++;
                    if (tapCount >= 2) {
                        // ÂºÄÂßãÊ∏∏Êàè
                        startGame();
                        tapCount = 0;
                        lastTapTime = 0;
                        
                        // ÊòæÁ§∫ÂèåÂáªÊèêÁ§∫Ê∂àÊÅØ
                        showMessage('ÂèåÂáªÂºÄÂßãÊ∏∏ÊàèÔºÅ', 2000);
                    }
                } else {
                    // ÈáçÁΩÆËÆ°Êï∞
                    tapCount = 1;
                }
                
                lastTapTime = currentTime;
            }
            
            // ‰∫ã‰ª∂ÁõëÂê¨
            window.addEventListener('keydown', (e) => {
                keys[e.key.toLowerCase()] = true;
                
                // Á©∫Ê†ºÈîÆÊöÇÂÅú/ÁªßÁª≠
                if (e.key === ' ') {
                    e.preventDefault();
                    if (gameState === 'playing') {
                        showPause();
                    } else if (gameState === 'paused') {
                        hidePause();
                    } else if (gameState === 'start' || gameState === 'gameOver') {
                        startGame();
                    }
                }
                
                // EÈîÆÊâìÂºÄ/ÂÖ≥Èó≠ÂïÜÂ∫ó
                if (e.key.toLowerCase() === 'e') {
                    if (gameState === 'playing') {
                        showShop();
                    } else if (gameState === 'shop') {
                        hideShop();
                    }
                }
                
                // Â∑¶Âè≥ÁÆ≠Â§¥ÈîÆÂàáÊç¢ÂïÜÂ∫óÈ°µÈù¢
                if (gameState === 'shop') {
                    const itemsPerPage = 4;
                    const pageCount = Math.ceil(shopItems.length / itemsPerPage);
                    
                    if (e.key === 'ArrowRight' && currentShopPage < pageCount - 1) {
                        currentShopPage++;
                    } else if (e.key === 'ArrowLeft' && currentShopPage > 0) {
                        currentShopPage--;
                    }
                }
                
                // ZÈîÆ‰∏ÄÈîÆÈÄöËøáÂΩìÂâçÊ≥¢Ê¨°Ôºà‰∏¥Êó∂ÂäüËÉΩÔºâ
                if (e.key.toLowerCase() === 'z' && gameState === 'playing' && !isInWaveTransition) {
                    skipWave();
                }
                
                // XÈîÆÂä†Èí±Ôºà‰∏¥Êó∂ÂäüËÉΩÔºâ
                if (e.key.toLowerCase() === 'x') {
                    const addMoneyAmount = 100;
                    gameData.money += addMoneyAmount;
                    showMessage(`Ëé∑Âæó ${addMoneyAmount} ÈáëÈí±ÔºÅ`, 1500);
                    updateUI();
                    console.log('Âä†Èí±ÂäüËÉΩÂ∑≤Ëß¶ÂèëÔºåÂΩìÂâçÈáëÈí±:', gameData.money);
                }
            });
            
            window.addEventListener('keyup', (e) => {
                keys[e.key.toLowerCase()] = false;
            });
            
            canvas.addEventListener('mousedown', (e) => {
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                // ÂºÄÂßãÁä∂ÊÄÅ‰∏ãÊ£ÄÊü•ÊåâÈíÆÁÇπÂáª
                if (gameState === 'start' && startButton) {
                    // Ê£ÄÊü•ÁÇπÂáªÊòØÂê¶Âú®ÂºÄÂßãÊåâÈíÆÂå∫ÂüüÂÜÖ
                    if (mouseX >= startButton.x && mouseX <= startButton.x + startButton.width &&
                        mouseY >= startButton.y && mouseY <= startButton.y + startButton.height) {
                        startGame();
                        return;
                    }
                }
                
                // Ê∏∏ÊàèÁªìÊùüÁä∂ÊÄÅ‰∏ãÊ£ÄÊü•ÊåâÈíÆÁÇπÂáª
                if (gameState === 'gameOver' && gameOverButton) {
                    // Ê£ÄÊü•ÁÇπÂáªÊòØÂê¶Âú®ÈáçÊñ∞ÂºÄÂßãÊåâÈíÆÂå∫ÂüüÂÜÖ
                    if (mouseX >= gameOverButton.x && mouseX <= gameOverButton.x + gameOverButton.width &&
                        mouseY >= gameOverButton.y && mouseY <= gameOverButton.y + gameOverButton.height) {
                        startGame();
                        return;
                    }
                }
                
                // ‰ªÖÂú®ÂïÜÂ∫óÁïåÈù¢Â§ÑÁêÜÁâ©ÂìÅÁÇπÂáª‰∫ã‰ª∂
                if (gameState === 'shop') {
                    // Ê£ÄÊü•ÁÇπÂáªÊòØÂê¶Âú®ÂïÜÂ∫óÁâ©ÂìÅ‰∏ä
                    const itemWidth = 300;
                    const itemHeight = 80;
                    const itemSpacing = 20;
                    const startY = 180;
                    const itemsPerPage = 4;
                    
                    // Âè™Ê£ÄÊü•ÂΩìÂâçÈ°µÈù¢ÊòæÁ§∫ÁöÑÁâ©ÂìÅ
                    const startIndex = currentShopPage * itemsPerPage;
                    const endIndex = Math.min(startIndex + itemsPerPage, shopItems.length);
                    
                    for (let i = startIndex; i < endIndex; i++) {
                        const item = shopItems[i];
                        const itemX = (canvas.width - itemWidth) / 2;
                        const itemY = startY + (i - startIndex) * (itemHeight + itemSpacing);
                        
                        // Ê£ÄÊü•ÁÇπÂáªÊòØÂê¶Âú®Áâ©ÂìÅÂå∫ÂüüÂÜÖ
                        if (mouseX >= itemX && mouseX <= itemX + itemWidth && 
                            mouseY >= itemY && mouseY <= itemY + itemHeight) {
                            purchaseItem(item.id);
                            break;
                        }
                    }
                }
            });
            
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                mouse.x = e.clientX - rect.left;
                mouse.y = e.clientY - rect.top;
            });
            
            // Ëß¶Êë∏Â∞ÑÂáª‰∫ã‰ª∂
            canvas.addEventListener('touchstart', (e) => {
                if (isMobile) {
                    e.preventDefault();
                    const touch = e.touches[0];
                    const rect = canvas.getBoundingClientRect();
                    const touchX = touch.clientX - rect.left;
                    const touchY = touch.clientY - rect.top;
                    mouse.x = touchX;
                    mouse.y = touchY;
                    
                    // ÂºÄÂßãÁä∂ÊÄÅ‰∏ãÊ£ÄÊü•ÊåâÈíÆÁÇπÂáª
                    if (gameState === 'start' && startButton) {
                        // Ê£ÄÊü•Ëß¶Êë∏ÊòØÂê¶Âú®ÂºÄÂßãÊåâÈíÆÂå∫ÂüüÂÜÖ
                        if (touchX >= startButton.x && touchX <= startButton.x + startButton.width &&
                            touchY >= startButton.y && touchY <= startButton.y + startButton.height) {
                            startGame();
                            return;
                        }
                    }
                    
                    // Ê∏∏ÊàèÁªìÊùüÁä∂ÊÄÅ‰∏ãÊ£ÄÊü•ÊåâÈíÆÁÇπÂáª
                    if (gameState === 'gameOver' && gameOverButton) {
                        // Ê£ÄÊü•Ëß¶Êë∏ÊòØÂê¶Âú®ÈáçÊñ∞ÂºÄÂßãÊåâÈíÆÂå∫ÂüüÂÜÖ
                        if (touchX >= gameOverButton.x && touchX <= gameOverButton.x + gameOverButton.width &&
                            touchY >= gameOverButton.y && touchY <= gameOverButton.y + gameOverButton.height) {
                            startGame();
                            return;
                        }
                    }
                    
                    if (gameState === 'playing') {
                        // Ëß¶ÂèëÂ∞ÑÂáª
                        if (player.autoAttack) {
                            player.autoAttack = false;
                        } else {
                            player.autoAttack = true;
                        }
                    } else if (gameState === 'start' || gameState === 'gameOver') {
                        // ÂèåÂáªÂºÄÂßãÊ∏∏ÊàèÊ£ÄÊµã
                        handleDoubleTapStartGame(e);
                    }
                }
            });
            
            canvas.addEventListener('touchmove', (e) => {
                if (isMobile && gameState === 'playing') {
                    e.preventDefault();
                    const touch = e.touches[0];
                    const rect = canvas.getBoundingClientRect();
                    mouse.x = touch.clientX - rect.left;
                    mouse.y = touch.clientY - rect.top;
                }
            });
            
            // ÂàùÂßãÂåñËß¶Êë∏ÊéßÂà∂
            window.addEventListener('load', () => {
                initTouchControls();
                initMobileEvents();
            });
            
            // Á™óÂè£Â§ßÂ∞èÂèòÂåñÊó∂ÈáçÊñ∞Ê£ÄÊµã
            window.addEventListener('resize', () => {
                initTouchControls();
            });
            
            // Ë¥≠‰π∞Áâ©ÂìÅÂáΩÊï∞
            window.purchaseItem = function(itemId) {
                const item = shopItems.find(i => i.id === itemId);
                if (!item) {
                    console.error('Áâ©ÂìÅ‰∏çÂ≠òÂú®:', itemId);
                    showMessage('Áâ©ÂìÅ‰∏çÂ≠òÂú®', 2000);
                    return;
                }
                
                if (gameData.money < item.price) {
                    console.error('ÈáëÈí±‰∏çË∂≥:', gameData.money, 'ÈúÄË¶Å:', item.price);
                    showMessage('ÈáëÈí±‰∏çË∂≥', 2000);
                    return;
                }
                
                // Êâ£Èô§ÈáëÂ∏Å
                gameData.money -= item.price;
                playSound('purchase'); // Êí≠ÊîæË¥≠‰π∞Èü≥Êïà
                
                // Â∫îÁî®Áâ©ÂìÅÊïàÊûú
                switch(item.type) {
                    case 'damage':
                        player.damage += item.value;
                        showMessage(`‰º§ÂÆ≥ +${item.value}`, 2000);
                        console.log('‰º§ÂÆ≥Â∑≤Êõ¥Êñ∞:', player.damage);
                        break;
                    case 'health':
                        player.health = Math.min(player.health + item.value, player.maxHealth);
                        showMessage(`ÁîüÂëΩ +${item.value}`, 2000);
                        break;
                    case 'fireRate':
                        player.fireRate *= (1 + item.value);
                        // Á°Æ‰øùÂ∞ÑÈÄü‰∏ç‰ºöËøáÂø´
                        if (player.fireRate < 500) player.fireRate = 500;
                        showMessage(`Â∞ÑÈÄü +20%`, 2000);
                        break;
                    case 'speed':
                        player.speed += item.value;
                        showMessage(`ÁßªÂä®ÈÄüÂ∫¶ +${item.value}`, 2000);
                        break;
                    case 'projectiles':
                        player.projectiles += item.value;
                        showMessage(`ÂºπÈÅì +${item.value}`, 2000);
                        console.log('ÂºπÈÅìÊï∞ÈáèÂ∑≤Êõ¥Êñ∞:', player.projectiles);
                        break;
                    case 'explosionRadius':
                        player.explosionRadius += item.value;
                        showMessage(`ÁàÜÁÇ∏ËåÉÂõ¥ +${item.value}`, 2000);
                        console.log('ÁàÜÁÇ∏ËåÉÂõ¥Â∑≤Êõ¥Êñ∞:', player.explosionRadius);
                        break;
                    case 'maxHealth':
                        player.maxHealth += item.value;
                        player.health += item.value;
                        showMessage(`ÁîüÂëΩ‰∏äÈôê +${item.value}`, 2000);
                        console.log('ÁîüÂëΩ‰∏äÈôêÂ∑≤Êõ¥Êñ∞:', player.maxHealth, 'ÂΩìÂâçÁîüÂëΩÂÄº:', player.health);
                        break;
                    case 'moneyBonus':
                        player.moneyBonus += item.value;
                        showMessage(`ÈáëÈí±Âä†Êàê +${(item.value * 100).toFixed(0)}%`, 2000);
                        break;
                    default:
                        console.error('Êú™Áü•ÁöÑÁâ©ÂìÅÁ±ªÂûã:', item.type);
                        showMessage('Ë¥≠‰π∞Â§±Ë¥•', 2000);
                        return;
                }
                
                // Êõ¥Êñ∞UI
                updateUI();
                updateShopUI();
                console.log('Ë¥≠‰π∞ÊàêÂäü:', item.name, 'Ââ©‰ΩôÈáëÈí±:', gameData.money);
            }

            // ÊòæÁ§∫ÂïÜÂ∫óÁïåÈù¢
            function showShop() {
                gameState = 'shop';
                const shopOverlay = document.getElementById('shop-overlay');
                shopOverlay.classList.add('active');
                updateShopUI();
                playSound('shopOpen');
            }

            // ÈöêËóèÂïÜÂ∫óÁïåÈù¢
            function hideShop() {
                gameState = 'playing';
                const shopOverlay = document.getElementById('shop-overlay');
                shopOverlay.classList.remove('active');
                playSound('shopClose');
            }

            // Êõ¥Êñ∞ÂïÜÂ∫óUI
            function updateShopUI() {
                const shopMoney = document.getElementById('shop-money');
                const shopWave = document.getElementById('shop-wave');
                const shopItemsGrid = document.getElementById('shop-items-grid');
                
                if (shopMoney) shopMoney.textContent = gameData.money;
                if (shopWave) shopWave.textContent = gameData.wave;
                
                // ÁîüÊàêÂïÜÂ∫óÁâ©ÂìÅ
                if (shopItemsGrid) {
                    shopItemsGrid.innerHTML = '';
                    shopItems.forEach(item => {
                        const itemElement = document.createElement('div');
                        itemElement.className = 'shop-item';
                        itemElement.innerHTML = `
                            <div class="item-header">
                                <div class="item-name">
                                    <span class="item-icon">${getItemIcon(item.type)}</span>
                                    ${item.name}
                                </div>
                                <div class="item-price">üí∞ ${item.price}</div>
                            </div>
                            <div class="item-description">${item.description}</div>
                            <div class="item-stats">
                                <span class="stat-tag">${getItemTypeName(item.type)}</span>
                            </div>
                            <button class="buy-button" ${gameData.money < item.price ? 'disabled' : ''} 
                                    onclick="window.purchaseItem(${item.id})">
                                ${gameData.money >= item.price ? 'üõí Ë¥≠‰π∞' : '‚ùå ÈáëÈí±‰∏çË∂≥'}
                            </button>
                        `;
                        shopItemsGrid.appendChild(itemElement);
                    });
                }
            }

            // Ëé∑ÂèñÁâ©ÂìÅÂõæÊ†á
            function getItemIcon(type) {
                const icons = {
                    'damage': '‚öîÔ∏è',
                    'health': '‚ù§Ô∏è',
                    'fireRate': '‚ö°',
                    'speed': 'üèÉ',
                    'projectiles': 'üéØ',
                    'explosionRadius': 'üí•',
                    'maxHealth': 'üõ°Ô∏è',
                    'moneyBonus': 'üí∞'
                };
                return icons[type] || 'üì¶';
            }

            // Ëé∑ÂèñÁâ©ÂìÅÁ±ªÂûãÂêçÁß∞
            function getItemTypeName(type) {
                const names = {
                    'damage': 'ÊîªÂáª',
                    'health': 'ÁîüÂëΩ',
                    'fireRate': 'Â∞ÑÈÄü',
                    'speed': 'ÈÄüÂ∫¶',
                    'projectiles': 'ÂºπÈÅì',
                    'explosionRadius': 'ËåÉÂõ¥',
                    'maxHealth': 'Èò≤Âæ°',
                    'moneyBonus': 'ÁªèÊµé'
                };
                return names[type] || 'ÈÅìÂÖ∑';
            }

            // ÊòæÁ§∫ÊöÇÂÅúÁïåÈù¢
            function showPause() {
                gameState = 'paused';
                const pauseOverlay = document.getElementById('pause-overlay');
                pauseOverlay.classList.add('active');
                updatePauseUI();
            }

            // ÈöêËóèÊöÇÂÅúÁïåÈù¢
            function hidePause() {
                gameState = 'playing';
                const pauseOverlay = document.getElementById('pause-overlay');
                pauseOverlay.classList.remove('active');
            }

            // Êõ¥Êñ∞ÊöÇÂÅúÁïåÈù¢UI
            function updatePauseUI() {
                const pauseWave = document.getElementById('pause-wave');
                const pauseKills = document.getElementById('pause-kills');
                const pauseScore = document.getElementById('pause-score');
                const pauseTime = document.getElementById('pause-time');
                
                if (pauseWave) pauseWave.textContent = gameData.wave;
                if (pauseKills) pauseKills.textContent = gameData.enemiesKilled;
                if (pauseScore) pauseScore.textContent = gameData.score;
                
                // ËÆ°ÁÆóÊ∏∏ÊàèÊó∂Èó¥
                const now = Date.now();
                const gameTime = Math.floor((now - gameStartTime) / 1000);
                const minutes = Math.floor(gameTime / 60);
                const seconds = gameTime % 60;
                if (pauseTime) pauseTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            // Ê∏∏ÊàèÂàùÂßãÂåñ
            function init() {
                // ÈöêËóèÂä†ËΩΩÂ±èÂπï
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                }, 1000);
                
                // Ê∑ªÂä†ÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
                document.getElementById('close-shop').addEventListener('click', () => {
                    playSound('uiClick');
                    hideShop();
                });
                document.getElementById('resume-game').addEventListener('click', () => {
                    playSound('uiClick');
                    hidePause();
                });
                document.getElementById('restart-game').addEventListener('click', () => {
                    playSound('uiClick');
                    startGame();
                });
                
                // ‰∏∫ÊâÄÊúâÊåâÈíÆÊ∑ªÂä†ÁÇπÂáªÈü≥Êïà
                document.querySelectorAll('button').forEach(button => {
                    button.addEventListener('click', () => {
                        playSound('uiClick');
                    });
                });
                
                // ÂàùÂßãÂåñÈü≥È¢ëÁ≥ªÁªü
                initAudio();
                
                // ÂºÄÂßãÊ∏∏ÊàèÂæ™ÁéØ
                requestAnimationFrame(gameLoop);
            }
            
            // ÂºÄÂßãÊñ∞Ê∏∏Êàè
            function startGame() {
                // ÈáçÁΩÆÊ∏∏ÊàèÁä∂ÊÄÅ
                gameState = 'playing';
                currentShopPage = 0; // ÈáçÁΩÆÂïÜÂ∫óÈ°µÁ†Å
                
                // ËÆ∞ÂΩïÊ∏∏ÊàèÂºÄÂßãÊó∂Èó¥
                gameStartTime = Date.now();
                
                // ÈöêËóèÊâÄÊúâÁïåÈù¢
                hideShop();
                hidePause();
                
                // ÈöêËóèÊïôÁ®ã
                const tutorial = document.querySelector('.mobile-tutorial');
                if (tutorial) {
                    tutorial.style.display = 'none';
                }
                
                // Ê∏ÖÁ©∫Ê∏∏ÊàèÂØπË±°
                enemies.length = 0;
                projectiles.length = 0;
                particles.length = 0;
                items.length = 0;
                messages.length = 0;
                
                // Êõ¥Êñ∞Ê∏∏ÊàèÊï∞ÊçÆ
                gameData.score = 0;
                gameData.money = 0;
                gameData.wave = 1;
                gameData.difficulty = 1;
                gameData.enemiesKilled = 0;
                gameData.enemiesPerWave = 2; // ÂáèÂ∞ëÁ¨¨‰∏ÄÊ≥¢Êïå‰∫∫Êï∞Èáè
                gameData.waveStartTime = 0; // ÈáçÁΩÆÊ≥¢Ê¨°ÂºÄÂßãÊó∂Èó¥
                
                // ÈáçÁΩÆÊ≥¢Ê¨°Áä∂ÊÄÅ
                isInWaveTransition = false;
                lastEnemySpawn = 0;
                
                // ÈáçÁΩÆÁé©ÂÆ∂
                player.x = canvas.width / 2;
                player.y = canvas.height / 2;
                player.health = player.maxHealth;
                player.damage = 10;
                player.speed = 3;
                player.fireRate = 1500;
                player.lastShot = 0;
                player.projectiles = 1;
                player.explosionRadius = 0;
                player.moneyBonus = 1.0;
                
                // Êõ¥Êñ∞UI
                updateUI();
                
                // ÊòæÁ§∫ÂºÄÂßãÊ∂àÊÅØÂπ∂ÁîüÊàêÁ¨¨‰∏ÄÊ≥¢Êïå‰∫∫
                showMessage(`Á¨¨1Ê≥¢ÂºÄÂßãÔºÅ`, 2000);
                setTimeout(() => {
                    if (gameState === 'playing') {
                        spawnWave();
                        lastEnemySpawn = Date.now();
                        gameData.waveStartTime = Date.now(); // ËÆ∞ÂΩïÁ¨¨‰∏ÄÊ≥¢ÂºÄÂßãÊó∂Èó¥
                    }
                }, 500);
            }
            
            // Êõ¥Êñ∞Ê∏∏ÊàèÁä∂ÊÄÅ
            function update() {
                console.log(`Ê∏∏ÊàèÊõ¥Êñ∞‰∏≠ - Áä∂ÊÄÅ: ${gameState}, Ê≥¢Ê¨°: ${gameData.wave}, Êïå‰∫∫: ${enemies.length}, Â∑≤ÂáªÊùÄ: ${gameData.enemiesKilled}/${gameData.enemiesPerWave}, ËøáÊ∏°Áä∂ÊÄÅ: ${isInWaveTransition}`);
                
                if (gameState !== 'playing') return;
                
                const now = Date.now();
                
                // Ê≥¢Ê¨°ËΩ¨Êç¢ÈÄªËæë - Âü∫‰∫éÂÄíËÆ°Êó∂
                if (gameData.waveStartTime > 0) {
                    const waveElapsedTime = now - gameData.waveStartTime;
                    const timeLeft = Math.max(0, gameData.waveDuration - waveElapsedTime);
                    
                    // ÂÄíËÆ°Êó∂ÁªìÊùüÔºåÊ≥¢Ê¨°ÂÆåÊàê
                    if (timeLeft <= 0 && !isInWaveTransition) {
                        // Ê∏ÖÈô§ÂΩìÂâçÊâÄÊúâÊÄ™Áâ©
                        enemies.length = 0;
                        console.log(`Ê≥¢Ê¨°${gameData.wave}ÂÄíËÆ°Êó∂ÁªìÊùüÔºåÊ∏ÖÈô§ÊâÄÊúâÊÄ™Áâ©`);
                        
                        // Ê≥¢Ê¨°ÂÆåÊàêÔºåËøõÂÖ•ËøáÊ∏°Áä∂ÊÄÅ
                        isInWaveTransition = true;
                        gameData.waveTimer = now;
                        
                        gameData.wave++;
                        gameData.difficulty += 0.2; // Â¢ûÂä†ÈöæÂ∫¶
                        // Á¨¨‰∏ÄÊ≥¢‰∏äÈôê4‰∏™ÔºåÂêéÁª≠Ê≥¢Ê¨°ÈÄêÊ∏êÂ¢ûÂä†
                        gameData.enemiesPerWave = Math.floor(4 + (gameData.wave - 1) * 1.2); // Á¨¨‰∏ÄÊ≥¢4‰∏™ÔºåÊØèÊ≥¢Â¢ûÂä†1.2‰∏™
                        gameData.enemiesKilled = 0;
                        
                        // Ê∑ªÂä†Ë∞ÉËØïÊó•Âøó
                        console.log(`Ê≥¢Ê¨°${gameData.wave-1}ÂÆåÊàêÔºåÂáÜÂ§áËøõÂÖ•Ê≥¢Ê¨°${gameData.wave}`);
                        
                        // Ê≥¢Ê¨°Â•ñÂä±
                        const waveReward = 10 + gameData.wave * 5;
                        gameData.money += waveReward;
                        showMessage(`Á¨¨${gameData.wave-1}Ê≥¢ÂÆåÊàêÔºÅËé∑ÂæóÂ•ñÂä±: ${waveReward}$`, 3000);
                        
                        // Êí≠ÊîæÊ≥¢Ê¨°ÂÆåÊàêÈü≥Êïà
                        playSound('waveComplete');
                        
                        // Êõ¥Êñ∞UI
                        updateUI();
                    }
                    
                    // ÂÄíËÆ°Êó∂ÁªìÊùüÂâçÊåÅÁª≠ÁîüÊàêÊïå‰∫∫ÔºåÈöæÂ∫¶ÈöèÊó∂Èó¥Â¢ûÂä†
                    if (timeLeft > 0 && !isInWaveTransition) {
                        // ËÆ°ÁÆóÂΩìÂâçÊ≥¢Ê¨°ÁöÑÂä®ÊÄÅÈöæÂ∫¶
                        const waveProgress = waveElapsedTime / gameData.waveDuration;
                        const currentDifficulty = gameData.difficulty * (1 + waveProgress * 0.2); // Ëøõ‰∏ÄÊ≠•Èôç‰ΩéÈöæÂ∫¶Â¢ûÈïøÈÄüÂ∫¶
                        
                        // Âä®ÊÄÅË∞ÉÊï¥ÁîüÊàêÈ¢ëÁéáÔºàÂ§ßÂπÖÈôç‰ΩéÂâçÊúüÈ¢ëÁéáÔºâ
                        const baseSpawnInterval = 3000; // Â§ßÂπÖÂ¢ûÂä†Âü∫Á°ÄÁîüÊàêÈó¥Èöî
                        const minSpawnInterval = 1200; // Â§ßÂπÖÂ¢ûÂä†ÊúÄÂ∞èÁîüÊàêÈó¥Èöî
                        const spawnInterval = Math.max(minSpawnInterval, baseSpawnInterval - waveProgress * 600); // Â§ßÂπÖÈôç‰ΩéÁîüÊàêÈ¢ëÁéáÂèòÂåñÂπÖÂ∫¶
                        
                        // Âä®ÊÄÅË∞ÉÊï¥Êïå‰∫∫Êï∞Èáè‰∏äÈôêÔºàÁ¨¨‰∏ÄÊ≥¢‰∏äÈôê4‰∏™ÔºåÂêéÁª≠Ê≥¢Ê¨°ÈÄêÊ∏êÂ¢ûÂä†Ôºâ
                        const baseMaxEnemies = Math.min(20, Math.floor(4 + (gameData.wave - 1) * 1.5)); // Á¨¨‰∏ÄÊ≥¢4‰∏™ÔºåÊØèÊ≥¢Â¢ûÂä†1.5‰∏™
                        const maxEnemies = Math.min(baseMaxEnemies, Math.floor(baseMaxEnemies + waveProgress * 3)); // Ê≥¢Ê¨°ÂÜÖÈÄêÊ∏êÂ¢ûÂä†
                        
                        // ÁîüÊàêÊïå‰∫∫ÔºàÊïå‰∫∫Êï∞Èáè‰∏çË∂≥‰∏äÈôêÔºâ
                        if (enemies.length < maxEnemies) {
                            if (now - lastEnemySpawn > spawnInterval) {
                                spawnEnemy(currentDifficulty);
                                lastEnemySpawn = now;
                            }
                        }
                    }
                }
                
                // Â§ÑÁêÜÊ≥¢Ê¨°ËøáÊ∏°Áä∂ÊÄÅ
                if (isInWaveTransition) {
                    const transitionProgress = now - gameData.waveTimer;
                    console.log(`Ê≥¢Ê¨°ËΩ¨Êç¢‰∏≠... Â∑≤Á≠âÂæÖ${transitionProgress}ms, ÈúÄË¶Å${gameData.waveTransitionTime}ms`);
                    if (transitionProgress >= gameData.waveTransitionTime) {
                        // ËøáÊ∏°ÁªìÊùüÔºåÂºÄÂßãÊñ∞Ê≥¢Ê¨°
                        isInWaveTransition = false;
                        console.log(`ÂºÄÂßãÁîüÊàêÊ≥¢Ê¨°${gameData.wave}`);
                        showMessage(`Á¨¨${gameData.wave}Ê≥¢ÂºÄÂßãÔºÅ`, 2000);
                        
                        // ËÆ∞ÂΩïÊ≥¢Ê¨°ÂºÄÂßãÊó∂Èó¥
                        gameData.waveStartTime = now;
                        
                        // ÁîüÊàêÊï¥Ê≥¢Êïå‰∫∫
                        spawnWave();
                        lastEnemySpawn = now;
                        
                        // Êí≠ÊîæÊ≥¢Ê¨°ÂºÄÂßãÈü≥Êïà
                        playSound('waveStart');
                    }
                }
                
                // ÈùûËøáÊ∏°Áä∂ÊÄÅ‰∏ãÊõ¥Êñ∞Ê∏∏Êàè
                if (!isInWaveTransition) {
                    // Áé©ÂÆ∂ÁßªÂä®ÈÄªËæë - ‰ªÖ‰ΩøÁî®ÈîÆÁõòÊéßÂà∂
            let isMoving = false;
            if (keys['w']) { player.y -= player.speed; isMoving = true; }
            if (keys['s']) { player.y += player.speed; isMoving = true; }
            if (keys['a']) { player.x -= player.speed; isMoving = true; }
            if (keys['d']) { player.x += player.speed; isMoving = true; }
            
            // Êí≠ÊîæÁßªÂä®Èü≥Êïà
            if (isMoving && Math.random() < 0.1) { // 10%Ê¶ÇÁéáÊí≠ÊîæÁßªÂä®Èü≥ÊïàÔºåÈÅøÂÖçËøá‰∫éÈ¢ëÁπÅ
                playSound('move');
            }
                    
                    // ËæπÁïåÊ£ÄÊü•
                    player.x = Math.max(player.width / 2, Math.min(canvas.width - player.width / 2, player.x));
                    player.y = Math.max(player.height / 2, Math.min(canvas.height - player.height / 2, player.y));
                    
                    // Ëá™Âä®ÊîªÂáª
                    if (now - player.lastShot > player.fireRate && enemies.length > 0) {
                        // ÊâæÂà∞ÊúÄËøëÁöÑÊïå‰∫∫
                        let closestEnemy = enemies[0];
                        let closestDistance = Infinity;
                        
                        for (const enemy of enemies) {
                            const distance = Math.sqrt(
                                Math.pow(enemy.x - player.x, 2) + 
                                Math.pow(enemy.y - player.y, 2)
                            );
                            if (distance < closestDistance) {
                                closestDistance = distance;
                                closestEnemy = enemy;
                            }
                        }
                        
                        // ÂêëÊúÄËøëÁöÑÊïå‰∫∫Â∞ÑÂáª
                        shoot(player.x, player.y, closestEnemy.x, closestEnemy.y);
                        player.lastShot = now;
                        playSound('shootMulti'); // Êí≠ÊîæÂ§öÂºπÈÅìÂ∞ÑÂáªÈü≥Êïà
                    }
                    
                    // ÁîüÊàêÊïå‰∫∫ÔºàÈùûËøáÊ∏°Áä∂ÊÄÅ‰∏îÊïå‰∫∫Êï∞Èáè‰∏çË∂≥Ôºâ
                    if (enemies.length < gameData.enemiesPerWave) {
                        if (now - lastEnemySpawn > 1000) {
                            spawnEnemy(gameData.difficulty);
                            lastEnemySpawn = now;
                        }
                    }
                }
                
                // Êõ¥Êñ∞Êïå‰∫∫
                for (let i = enemies.length - 1; i >= 0; i--) {
                    const enemy = enemies[i];
                    
                    // ÁÆÄÂçïÁöÑËøΩÈÄêË°å‰∏∫
                    const dx = player.x - enemy.x;
                    const dy = player.y - enemy.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance > 0) {
                        enemy.x += (dx / distance) * enemy.speed;
                        enemy.y += (dy / distance) * enemy.speed;
                    }
                    
                    // Á¢∞ÊíûÊ£ÄÊµã - Êïå‰∫∫‰∏éÁé©ÂÆ∂
                    if (checkCollision(enemy, player)) {
                        player.health -= 1;
                        createParticles(enemy.x, enemy.y, enemy.color, 5);
                        playSound('playerHit'); // Êí≠ÊîæÁé©ÂÆ∂Âèó‰º§Èü≥Êïà
                        
                        // ÁßªÈô§Êïå‰∫∫
                        enemies.splice(i, 1);
                        
                        // Êõ¥Êñ∞UI
                        updateUI();
                        
                        // Ê£ÄÊü•Ê∏∏ÊàèÁªìÊùü
                        if (player.health <= 0) {
                            gameState = 'gameOver';
                            player.health = 0;
                            playSound('playerDeath'); // Êí≠ÊîæÁé©ÂÆ∂Ê≠ª‰∫°Èü≥Êïà
                        }
                    }
                }
                
                // ÊØè100Â∏ßËæìÂá∫‰∏ÄÊ¨°Ë∞ÉËØï‰ø°ÊÅØÔºåÊ£ÄÊü•Â±ûÊÄßÊòØÂê¶Ë¢´ÈáçÁΩÆ
                if (frameCount % 100 === 0) {
                    console.log('Ê∏∏ÊàèÂæ™ÁéØÊ£ÄÊü• - ÂºπÈÅìÊï∞:', player.projectiles, 'ÁàÜÁÇ∏ËåÉÂõ¥:', player.explosionRadius, 'ÁîüÂëΩ‰∏äÈôê:', player.maxHealth);
                }
                frameCount++;
                
                // Êõ¥Êñ∞ÊäïÂ∞ÑÁâ©
                for (let i = projectiles.length - 1; i >= 0; i--) {
                    const projectile = projectiles[i];
                    
                    // ÁßªÂä®ÊäïÂ∞ÑÁâ©
                    projectile.x += projectile.vx;
                    projectile.y += projectile.vy;
                    
                    // ËæπÁïåÊ£ÄÊü•
                    if (projectile.x < -projectile.radius || 
                        projectile.x > canvas.width + projectile.radius ||
                        projectile.y < -projectile.radius || 
                        projectile.y > canvas.height + projectile.radius) {
                        projectiles.splice(i, 1);
                        continue;
                    }
                    
                    // Â§ÑÁêÜÁàÜÁÇ∏ËåÉÂõ¥ÊîªÂáª
                    if (player.explosionRadius > 0) {
                        // Ë∞ÉËØï‰ø°ÊÅØ
                        if (i === 0) console.log('‰ΩøÁî®ËåÉÂõ¥ÊîªÂáªÔºåÁàÜÁÇ∏ÂçäÂæÑ:', player.explosionRadius);
                        
                        let hitAnyEnemy = false;
                        
                        // ÁªòÂà∂ÁàÜÁÇ∏ËåÉÂõ¥ÂúÜÂúàÔºà‰ªÖÁî®‰∫éË∞ÉËØïÂíåËßÜËßâÊïàÊûúÔºâ
                        ctx.save();
                        ctx.strokeStyle = 'rgba(255, 193, 7, 0.5)';
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.arc(projectile.x, projectile.y, player.explosionRadius, 0, Math.PI * 2);
                        ctx.stroke();
                        ctx.restore();
                        
                        for (let j = enemies.length - 1; j >= 0; j--) {
                            const enemy = enemies[j];
                            const dx = enemy.x - projectile.x;
                            const dy = enemy.y - projectile.y;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            
                            // Ë∞ÉËØïÔºöÊòæÁ§∫Ë∑ùÁ¶ª‰ø°ÊÅØ
                            if (distance < player.explosionRadius + 20) {
                                console.log('Êïå‰∫∫Ë∑ùÁ¶ªÂ≠êÂºπ:', distance, 'ÁàÜÁÇ∏ÂçäÂæÑ:', player.explosionRadius);
                            }
                            
                            if (distance <= player.explosionRadius) {
                                // Êïå‰∫∫Âèó‰º§
                                enemy.health -= projectile.damage;
                                createParticles(projectile.x, projectile.y, projectile.color, 3);
                                playSound('enemyHit'); // Êí≠ÊîæÊïå‰∫∫Âèó‰º§Èü≥Êïà
                                hitAnyEnemy = true;
                                
                                // Êí≠ÊîæÁàÜÁÇ∏Èü≥ÊïàÔºàÂè™Âú®Á¨¨‰∏ÄÊ¨°Âáª‰∏≠Êó∂Êí≠ÊîæÔºâ
                                if (!hitAnyEnemy) {
                                    playSound('explosion');
                                }
                                
                                // Ë∞ÉËØïÔºöÊòæÁ§∫Âáª‰∏≠‰ø°ÊÅØ
                                console.log('ËåÉÂõ¥ÊîªÂáªÂáª‰∏≠Êïå‰∫∫ÔºåÈÄ†Êàê‰º§ÂÆ≥:', projectile.damage);
                                
                                // Ê£ÄÊü•Êïå‰∫∫ÊòØÂê¶Ê≠ª‰∫°
                                if (enemy.health <= 0) {
                                    // ÁîüÊàêÁ≤íÂ≠êÊïàÊûú
                                    createParticles(enemy.x, enemy.y, enemy.color, 10);
                                    
                                    // Â¢ûÂä†ÂàÜÊï∞ÂíåÈáëÈí±
                                    gameData.score += 10 * gameData.difficulty;
                                    const baseMoney = enemy.money || (Math.floor(Math.random() * 5) + 1);
                                    gameData.money += Math.floor(baseMoney * player.moneyBonus);
                                    gameData.enemiesKilled++;
                                    
                                    // ÁßªÈô§Êïå‰∫∫
                                    enemies.splice(j, 1);
                                    playSound('enemyDeath'); // Êí≠ÊîæÊïå‰∫∫Ê≠ª‰∫°Èü≥Êïà
                                    
                                    // Êõ¥Êñ∞UI
                                    updateUI();
                                }
                            }
                        }
                        
                        // Â¶ÇÊûúÊúâÊïå‰∫∫Ë¢´Âáª‰∏≠ÔºåÊòæÁ§∫ÁàÜÁÇ∏ÊïàÊûúÂπ∂ÁßªÈô§Â≠êÂºπ
                        if (hitAnyEnemy) {
                            createParticles(projectile.x, projectile.y, '#ff9800', 15);
                            projectiles.splice(i, 1);
                        }
                    } else {
                        // ÊôÆÈÄöÂ≠êÂºπÁ¢∞ÊíûÊ£ÄÊµã
                        for (let j = enemies.length - 1; j >= 0; j--) {
                            const enemy = enemies[j];
                            if (checkCircleCollision(projectile, enemy)) {
                                // Êïå‰∫∫Âèó‰º§
                                enemy.health -= projectile.damage;
                                createParticles(projectile.x, projectile.y, projectile.color, 3);
                                
                                // ÁßªÈô§ÊäïÂ∞ÑÁâ©
                                projectiles.splice(i, 1);
                                
                                // Ê£ÄÊü•Êïå‰∫∫Ê≠ª‰∫°
                                if (enemy.health <= 0) {
                                    // ÁîüÊàêÁ≤íÂ≠êÊïàÊûú
                                    createParticles(enemy.x, enemy.y, enemy.color, 10);
                                    
                                    // Â¢ûÂä†ÂàÜÊï∞ÂíåÈáëÈí±
                                    gameData.score += 10 * gameData.difficulty;
                                    const baseMoney = enemy.money || (Math.floor(Math.random() * 5) + 1);
                                    gameData.money += Math.floor(baseMoney * player.moneyBonus);
                                    gameData.enemiesKilled++;
                                    
                                    // ÁßªÈô§Êïå‰∫∫
                                    enemies.splice(j, 1);
                                    playSound('enemyDeath'); // Êí≠ÊîæÊïå‰∫∫Ê≠ª‰∫°Èü≥Êïà
                                    
                                    // Êõ¥Êñ∞UI
                                    updateUI();
                                }
                                
                                break;
                            }
                        }
                    }
                }
                
                // Êõ¥Êñ∞Á≤íÂ≠ê
                for (let i = particles.length - 1; i >= 0; i--) {
                    const particle = particles[i];
                    
                    // ÁßªÂä®Á≤íÂ≠ê
                    particle.x += particle.vx;
                    particle.y += particle.vy;
                    
                    // Êõ¥Êñ∞ÁîüÂëΩÂë®Êúü
                    particle.life -= 0.02;
                    
                    if (particle.life <= 0) {
                        particles.splice(i, 1);
                    }
                }
            }
            
            // ÁîüÊàê‰∏ÄÊ≥¢Êïå‰∫∫
            function spawnWave() {
                console.log(`ÂºÄÂßãÁîüÊàêÊ≥¢Ê¨°${gameData.wave}ÁöÑÊïå‰∫∫ÔºåËÆ°ÂàíÁîüÊàê${gameData.enemiesPerWave}‰∏™`);
                for (let i = 0; i < gameData.enemiesPerWave; i++) {
                    console.log(`ËÆæÁΩÆÂÆöÊó∂Âô®ÁîüÊàêÁ¨¨${i+1}‰∏™Êïå‰∫∫ÔºåÂª∂Ëøü${i*200}ms`);
                    setTimeout(() => {
                        spawnEnemy(gameData.difficulty);
                    }, i * 200);
                }
            }
            
            // ÁîüÊàêÊïå‰∫∫ÔºàÂõ∫ÂÆöË°ÄÈáèÔºåÊ≥¢Ê¨°ÈÄíÂ¢ûÈöæÂ∫¶Ôºâ
            function spawnEnemy(currentDifficulty = gameData.difficulty) {
                // Ê∑ªÂä†È¢ùÂ§ñÊ£ÄÊü•ÔºåÁ°Æ‰øùÂè™ÊúâÂú®playingÁä∂ÊÄÅÊâçÁîüÊàêÊïå‰∫∫
                if (gameState !== 'playing') {
                    console.log(`Ë≠¶ÂëäÔºöÂ∞ùËØïÂú®ÈùûplayingÁä∂ÊÄÅÁîüÊàêÊïå‰∫∫ÔºåÂΩìÂâçÁä∂ÊÄÅ: ${gameState}`);
                    return;
                }
                
                console.log(`ÁîüÊàê‰∏Ä‰∏™Êïå‰∫∫ÔºåÂΩìÂâçÊ≥¢Ê¨°: ${gameData.wave}`);
                // Ê†πÊçÆÊ≥¢Ê¨°ÂÜ≥ÂÆöÊïå‰∫∫Á±ªÂûã
                const rand = Math.random();
                let enemyType;
                
                // ÁâπÊÆäÊÄ™ÊØèÂõõÊ≥¢Âá∫Áé∞‰∏ÄÁßçÊñ∞ÊÄ™
                const waveGroup = Math.floor((gameData.wave - 1) / 4); // ÊØè4Ê≥¢‰∏Ä‰∏™Èò∂ÊÆµ
                
                // Ê†πÊçÆÊ≥¢Ê¨°Èò∂ÊÆµË∞ÉÊï¥Êïå‰∫∫Á±ªÂûãÂá∫Áé∞Ê¶ÇÁéá
                let eliteChance = 0;
                let fastChance = 0;
                
                if (waveGroup >= 1) { // Á¨¨5Ê≥¢ÂºÄÂßãÂá∫Áé∞Âø´ÈÄüÊïå‰∫∫
                    fastChance = Math.min(0.2, 0.05 + (waveGroup - 1) * 0.05);
                }
                
                if (waveGroup >= 2) { // Á¨¨9Ê≥¢ÂºÄÂßãÂá∫Áé∞Á≤æËã±Êïå‰∫∫
                    eliteChance = Math.min(0.15, 0.03 + (waveGroup - 2) * 0.04);
                }
                
                // Âõ∫ÂÆöÊÄ™Áâ©Ë°ÄÈáèÔºå‰∏çÈöèÈöæÂ∫¶ÂèòÂåñ
                if (waveGroup === 0) {
                    // Ââç4Ê≥¢Âè™ÊúâÊôÆÈÄöÊïå‰∫∫ÔºåÂõ∫ÂÆöÂ±ûÊÄß
                    enemyType = {
                        width: 30,
                        height: 30,
                        health: 20, // Âõ∫ÂÆöË°ÄÈáè
                        damage: 3, // Âõ∫ÂÆö‰º§ÂÆ≥
                        speed: 1.2, // Âõ∫ÂÆöÈÄüÂ∫¶
                        money: 5,
                        color: '#f44336',
                        type: 'normal'
                    };
                } else if (rand < eliteChance) {
                    // Á≤æËã±Êïå‰∫∫ÔºàÁ¨¨9Ê≥¢ÂºÄÂßãÂá∫Áé∞Ôºâ
                    enemyType = {
                        width: 35,
                        height: 35,
                        health: 60, // Âõ∫ÂÆöË°ÄÈáè
                        damage: 8, // Âõ∫ÂÆö‰º§ÂÆ≥
                        speed: 1.0, // Âõ∫ÂÆöÈÄüÂ∫¶
                        money: Math.floor(15 + (gameData.wave - 1) * 0.5), // Ê≥¢Ê¨°Â¢ûÂä†ÈáëÈí±
                        color: '#ff5722',
                        type: 'elite'
                    };
                } else if (rand < eliteChance + fastChance) {
                    // Âø´ÈÄüÊïå‰∫∫ÔºàÁ¨¨5Ê≥¢ÂºÄÂßãÂá∫Áé∞Ôºâ
                    enemyType = {
                        width: 25,
                        height: 25,
                        health: 25, // Âõ∫ÂÆöË°ÄÈáè
                        damage: 5, // Âõ∫ÂÆö‰º§ÂÆ≥
                        speed: 2.5, // Âõ∫ÂÆöÈÄüÂ∫¶
                        money: Math.floor(10 + (gameData.wave - 1) * 0.3), // Ê≥¢Ê¨°Â¢ûÂä†ÈáëÈí±
                        color: '#ffeb3b',
                        type: 'fast'
                    };
                } else {
                    // ÊôÆÈÄöÊïå‰∫∫ÔºàÂõ∫ÂÆöÂ±ûÊÄßÔºâ
                    enemyType = {
                        width: 30,
                        height: 30,
                        health: 25, // Âõ∫ÂÆöË°ÄÈáè
                        damage: 4, // Âõ∫ÂÆö‰º§ÂÆ≥
                        speed: 1.3, // Âõ∫ÂÆöÈÄüÂ∫¶
                        money: Math.floor(6 + (gameData.wave - 1) * 0.2), // Ê≥¢Ê¨°Â¢ûÂä†ÈáëÈí±
                        color: '#f44336',
                        type: 'normal'
                    };
                }
                
                // ÈöèÊú∫ÁîüÊàê‰ΩçÁΩÆÔºà‰ªéÂ±èÂπïËæπÁºòÔºâ
                let x, y;
                const side = Math.floor(Math.random() * 4); // 0:‰∏ä, 1:Âè≥, 2:‰∏ã, 3:Â∑¶
                const offset = Math.random() * 200 - 100; // ËæπÁºòÂÅèÁßª
                
                switch (side) {
                    case 0: // ‰∏ä
                        x = canvas.width / 2 + offset;
                        y = -50;
                        break;
                    case 1: // Âè≥
                        x = canvas.width + 50;
                        y = canvas.height / 2 + offset;
                        break;
                    case 2: // ‰∏ã
                        x = canvas.width / 2 + offset;
                        y = canvas.height + 50;
                        break;
                    case 3: // Â∑¶
                        x = -50;
                        y = canvas.height / 2 + offset;
                        break;
                }
                
                // ÂàõÂª∫Êïå‰∫∫
                enemies.push({
                    x,
                    y,
                    ...enemyType
                });
            }
            
            // Â∞ÑÂáª
            function shoot(fromX, fromY, toX, toY) {
                const dx = toX - fromX;
                const dy = toY - fromY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                // ÈÅøÂÖçÈô§‰ª•Èõ∂
                if (distance === 0) return;
                
                const speed = 8;
                
                // Ë∞ÉËØï‰ø°ÊÅØ
                console.log('Â∞ÑÂáªÊó∂ÂºπÈÅìÊï∞Èáè:', player.projectiles);
                
                // Ê†πÊçÆÂºπÈÅìÊï∞ÈáèÁîüÊàêÂ§ö‰∏™Â≠êÂºπ
                for (let i = 0; i < player.projectiles; i++) {
                    // ËÆ°ÁÆóÂ≠êÂºπËßíÂ∫¶ÂÅèÁßªÔºàÊØèÂ¢ûÂä†‰∏Ä‰∏™ÂºπÈÅìÔºåËßíÂ∫¶Êâ©Â±ïÊõ¥Â§öÔºâ
                    const angle = Math.atan2(dy, dx);
                    // Ë∞ÉÊï¥ÂÅèÁßªÈáèÔºå‰ΩøÂÖ∂Êõ¥ÊòéÊòæ
                    const angleOffset = (i - (player.projectiles - 1) / 2) * 0.2;
                    
                    // ËÆ°ÁÆóÂÅèÁßªÂêéÁöÑÈÄüÂ∫¶ÂàÜÈáè
                    const vx = Math.cos(angle + angleOffset) * speed;
                    const vy = Math.sin(angle + angleOffset) * speed;
                    
                    // ÂàõÂª∫‰∏çÂêåÈ¢úËâ≤ÁöÑÂ≠êÂºπÔºå‰ΩøÂ§ö‰∏™ÂºπÈÅìÊõ¥ÊòéÊòæ
                    const colors = ['#ffeb3b', '#ff9800', '#e91e63', '#9c27b0', '#2196f3'];
                    const color = colors[i % colors.length];
                    
                    // ÂàõÂª∫Â≠êÂºπ
                    projectiles.push({
                        x: fromX,
                        y: fromY,
                        radius: 5,
                        damage: player.damage,
                        vx: vx,
                        vy: vy,
                        color: color,
                        trail: [] // Áî®‰∫éÁªòÂà∂ËΩ®Ëøπ
                    });
                    
                    // Ê∑ªÂä†Â∞ÑÂáªÈü≥Êïà
                    playSound('shootMulti');
                }
            }
            // ÂàõÂª∫Á≤íÂ≠êÊïàÊûú
            function createParticles(x, y, color, count) {
                for (let i = 0; i < count; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = Math.random() * 3 + 1;
                    
                    particles.push({
                        x: x,
                        y: y,
                        size: Math.random() * 3 + 2,
                        vx: Math.cos(angle) * speed,
                        vy: Math.sin(angle) * speed,
                        life: Math.random() * 0.5 + 0.5,
                        color: color
                    });
                }
            }
            
            // Á¢∞ÊíûÊ£ÄÊµã - Áü©ÂΩ¢
            function checkCollision(a, b) {
                return a.x < b.x + b.width &&
                       a.x + a.width > b.x &&
                       a.y < b.y + b.height &&
                       a.y + a.height > b.y;
            }
            
            // Á¢∞ÊíûÊ£ÄÊµã - ÂúÜÂΩ¢‰∏éÁü©ÂΩ¢
            function checkCircleCollision(circle, rect) {
                const closestX = Math.max(rect.x, Math.min(circle.x, rect.x + rect.width));
                const closestY = Math.max(rect.y, Math.min(circle.y, rect.y + rect.height));
                
                const distanceX = circle.x - closestX;
                const distanceY = circle.y - closestY;
                
                return (distanceX * distanceX + distanceY * distanceY) <= (circle.radius * circle.radius);
            }
            
            // ‰∏ÄÈîÆÈÄöËøáÂΩìÂâçÊ≥¢Ê¨°Ôºà‰∏¥Êó∂ÂäüËÉΩÔºâ
            function skipWave() {
                if (!isInWaveTransition) {
                    // Áõ¥Êé•ËøõÂÖ•Ê≥¢Ê¨°ËΩ¨Êç¢Áä∂ÊÄÅ
                    isInWaveTransition = true;
                    gameData.waveTimer = Date.now();
                    gameData.wave++;
                    gameData.difficulty += 0.2; // Â¢ûÂä†ÈöæÂ∫¶
                    gameData.enemiesPerWave = Math.floor(2 + gameData.wave * 1.2); // ÊØèÊ≥¢Êïå‰∫∫Êï∞ÈáèÂ¢ûÂä†
                    gameData.enemiesKilled = gameData.enemiesPerWave; // Áõ¥Êé•ËÆæÁΩÆ‰∏∫ÂÆåÊàêÊù°‰ª∂
                    
                    // Ê∏ÖÈô§ÊâÄÊúâÂâ©‰ΩôÊïå‰∫∫
                    enemies.length = 0;
                    
                    // Ê≥¢Ê¨°Â•ñÂä±
                    const waveReward = 10 + gameData.wave * 5;
                    gameData.money += waveReward;
                    showMessage(`Á¨¨${gameData.wave-1}Ê≥¢Ë∑≥ËøáÔºÅËé∑ÂæóÂ•ñÂä±: ${waveReward}$`, 3000);
                    
                    // Êí≠ÊîæÊ≥¢Ê¨°ÂÆåÊàêÈü≥Êïà
                    playSound('waveComplete');
                    
                    // Êõ¥Êñ∞UI
                    updateUI();
                }
            }
            
            // Êõ¥Êñ∞UI
            function updateUI() {
                // Ë∞ÉËØï‰ø°ÊÅØ
                console.log('Êõ¥Êñ∞UI - ÁîüÂëΩÂÄº:', player.health, 'ÁîüÂëΩ‰∏äÈôê:', player.maxHealth);
                
                // Êõ¥Êñ∞ÁîüÂëΩÂÄº
                const healthPercent = (player.health / player.maxHealth) * 100;
                healthFill.style.width = `${healthPercent}%`;
                healthValue.textContent = `${Math.floor(player.health)}/${player.maxHealth}`;
                
                // Êõ¥Êñ∞ÈáëÈí±
                moneyValue.textContent = gameData.money;
                
                // Êõ¥Êñ∞Êïå‰∫∫Êï∞Èáè
                enemiesCount.textContent = enemies.length;
                
                // Êõ¥Êñ∞ÂàÜÊï∞
                scoreValue.textContent = gameData.score;
                
                // Êõ¥Êñ∞Áé©ÂÆ∂Â±ûÊÄßË°®
                updatePlayerStats();
            }
            
            // Êõ¥Êñ∞Áé©ÂÆ∂Â±ûÊÄßË°®
            function updatePlayerStats() {
                // ÊîªÂáªÂäõ
                const statDamage = document.getElementById('stat-damage');
                if (statDamage) statDamage.textContent = player.damage;
                
                // ÊîªÈÄüÔºàËΩ¨Êç¢‰∏∫ÊØèÁßíÊîªÂáªÊ¨°Êï∞Ôºâ
                const attackSpeed = Math.round(1000 / player.fireRate * 10) / 10;
                const statAttackSpeed = document.getElementById('stat-attack-speed');
                if (statAttackSpeed) statAttackSpeed.textContent = `${attackSpeed}/Áßí`;
                
                // ÂºπÈÅìÊï∞Èáè
                const statProjectiles = document.getElementById('stat-projectiles');
                if (statProjectiles) statProjectiles.textContent = player.projectiles;
                
                // ÁàÜÁÇ∏ÂçäÂæÑ
                const statExplosionRadius = document.getElementById('stat-explosion-radius');
                if (statExplosionRadius) statExplosionRadius.textContent = player.explosionRadius;
                
                // ÁßªÂä®ÈÄüÂ∫¶
                const statSpeed = document.getElementById('stat-speed');
                if (statSpeed) statSpeed.textContent = player.speed;
                
                // ÈáëÈí±Âä†Êàê
                const moneyBonusPercent = Math.round((player.moneyBonus - 1) * 100);
                const statMoneyBonus = document.getElementById('stat-money-bonus');
                if (statMoneyBonus) statMoneyBonus.textContent = `+${moneyBonusPercent}%`;
            }
            
            // ÁªòÂà∂Ê∏∏Êàè
            function render() {
                // ÁªòÂà∂Âä®ÊÄÅÊ∏êÂèòËÉåÊôØ
                const gradient = ctx.createRadialGradient(
                    canvas.width / 2, canvas.height / 2, 0,
                    canvas.width / 2, canvas.height / 2, Math.max(canvas.width, canvas.height) / 2
                );
                const time = Date.now() * 0.001;
                gradient.addColorStop(0, `hsl(${Math.sin(time * 0.5) * 30 + 220}, 20%, 8%)`);
                gradient.addColorStop(0.5, `hsl(${Math.sin(time * 0.3) * 20 + 240}, 15%, 5%)`);
                gradient.addColorStop(1, '#000000');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // ÁªòÂà∂Âä®ÊÄÅËÉåÊôØÁΩëÊ†º
                ctx.save();
                ctx.strokeStyle = `rgba(255, 255, 255, ${0.03 + Math.sin(time) * 0.02})`;
                ctx.lineWidth = 0.5;
                const gridSize = 40;
                const offsetX = (time * 10) % gridSize;
                const offsetY = (time * 8) % gridSize;
                
                for (let x = -offsetX; x < canvas.width + gridSize; x += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.stroke();
                }
                for (let y = -offsetY; y < canvas.height + gridSize; y += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                    ctx.stroke();
                }
                ctx.restore();
                
                // ÁªòÂà∂Â¢ûÂº∫Á≤íÂ≠êÊïàÊûú
                for (const particle of particles) {
                    ctx.save();
                    ctx.globalAlpha = particle.life;
                    
                    // ÂàõÂª∫Á≤íÂ≠êÊ∏êÂèò
                    const particleGradient = ctx.createRadialGradient(
                        particle.x, particle.y, 0,
                        particle.x, particle.y, particle.size * 2
                    );
                    particleGradient.addColorStop(0, particle.color);
                    particleGradient.addColorStop(0.7, particle.color.replace(')', ', 0.5)').replace('rgb', 'rgba'));
                    particleGradient.addColorStop(1, 'transparent');
                    
                    ctx.fillStyle = particleGradient;
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, particle.size * 2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // ÁªòÂà∂Á≤íÂ≠êÊ†∏ÂøÉ
                    ctx.fillStyle = particle.color;
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                }
                

                
                // ÁªòÂà∂Â¢ûÂº∫ÊäïÂ∞ÑÁâ©ÊïàÊûú
                for (const projectile of projectiles) {
                    ctx.save();
                    
                    // ÁªòÂà∂ÊäïÂ∞ÑÁâ©ËΩ®Ëøπ
                    ctx.globalAlpha = 0.6;
                    ctx.strokeStyle = projectile.color;
                    ctx.lineWidth = projectile.radius;
                    ctx.lineCap = 'round';
                    ctx.beginPath();
                    const trailLength = 15;
                    ctx.moveTo(projectile.x - projectile.vx * 0.3, projectile.y - projectile.vy * 0.3);
                    ctx.lineTo(projectile.x - projectile.vx * 0.1, projectile.y - projectile.vy * 0.1);
                    ctx.stroke();
                    
                    // ÁªòÂà∂ÊäïÂ∞ÑÁâ©ÂÖâÊôï
                    ctx.globalAlpha = 0.4;
                    const projectileGradient = ctx.createRadialGradient(
                        projectile.x, projectile.y, 0,
                        projectile.x, projectile.y, projectile.radius * 3
                    );
                    projectileGradient.addColorStop(0, projectile.color);
                    projectileGradient.addColorStop(1, 'transparent');
                    ctx.fillStyle = projectileGradient;
                    ctx.beginPath();
                    ctx.arc(projectile.x, projectile.y, projectile.radius * 3, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // ÁªòÂà∂ÊäïÂ∞ÑÁâ©Ê†∏ÂøÉ
                    ctx.globalAlpha = 1;
                    ctx.fillStyle = projectile.color;
                    ctx.beginPath();
                    ctx.arc(projectile.x, projectile.y, projectile.radius, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Ê∑ªÂä†Èó™ÁÉÅÊïàÊûú
                    if (Math.random() < 0.3) {
                        ctx.fillStyle = '#ffffff';
                        ctx.beginPath();
                        ctx.arc(projectile.x, projectile.y, projectile.radius * 0.5, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    
                    ctx.restore();
                }
                
                // ÁªòÂà∂Â¢ûÂº∫Êïå‰∫∫ÊïàÊûú
                for (const enemy of enemies) {
                    ctx.save();
                    
                    // Êïå‰∫∫Èò¥ÂΩ±ÊïàÊûú
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                    ctx.shadowBlur = 8;
                    ctx.shadowOffsetX = 3;
                    ctx.shadowOffsetY = 3;
                    
                    // Ê†πÊçÆÊïå‰∫∫Á±ªÂûãÊ∑ªÂä†ÁâπÊÆäÊïàÊûú
                    if (enemy.type === 'elite') {
                        // Á≤æËã±Êïå‰∫∫ÂèëÂÖâÊïàÊûú
                        const eliteGradient = ctx.createRadialGradient(
                            enemy.x, enemy.y, 0,
                            enemy.x, enemy.y, enemy.width
                        );
                        eliteGradient.addColorStop(0, enemy.color);
                        eliteGradient.addColorStop(0.7, enemy.color.replace(')', ', 0.8)').replace('rgb', 'rgba'));
                        eliteGradient.addColorStop(1, 'transparent');
                        ctx.fillStyle = eliteGradient;
                        ctx.fillRect(enemy.x - enemy.width, enemy.y - enemy.height, enemy.width * 2, enemy.height * 2);
                    }
                    
                    // ÁªòÂà∂Êïå‰∫∫‰∏ª‰ΩìÔºàÂúÜÂΩ¢ËÄåÈùûÁü©ÂΩ¢ÔºåÊõ¥Áé∞‰ª£Ôºâ
                    const enemyGradient = ctx.createRadialGradient(
                        enemy.x - enemy.width * 0.3, enemy.y - enemy.height * 0.3, 0,
                        enemy.x, enemy.y, Math.max(enemy.width, enemy.height) / 2
                    );
                    enemyGradient.addColorStop(0, enemy.color.replace(')', ', 1)').replace('rgb', 'rgba'));
                    enemyGradient.addColorStop(0.7, enemy.color);
                    enemyGradient.addColorStop(1, enemy.color.replace(')', ', 0.8)').replace('rgb', 'rgba'));
                    
                    ctx.fillStyle = enemyGradient;
                    ctx.beginPath();
                    ctx.arc(enemy.x, enemy.y, Math.max(enemy.width, enemy.height) / 2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // ÁªòÂà∂Êïå‰∫∫ËæπÊ°Ü
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 1;
                    ctx.globalAlpha = 0.6;
                    ctx.stroke();
                    ctx.globalAlpha = 1;
                    
                    // ÁªòÂà∂Êïå‰∫∫ÁúºÁùõÔºàÂ¢ûÂä†ÁîüÂëΩÂäõÔºâ
                    ctx.fillStyle = '#ffffff';
                    const eyeSize = enemy.width * 0.08;
                    ctx.beginPath();
                    ctx.arc(enemy.x - enemy.width * 0.15, enemy.y - enemy.height * 0.1, eyeSize, 0, Math.PI * 2);
                    ctx.arc(enemy.x + enemy.width * 0.15, enemy.y - enemy.height * 0.1, eyeSize, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#000000';
                    ctx.beginPath();
                    ctx.arc(enemy.x - enemy.width * 0.15, enemy.y - enemy.height * 0.1, eyeSize * 0.5, 0, Math.PI * 2);
                    ctx.arc(enemy.x + enemy.width * 0.15, enemy.y - enemy.height * 0.1, eyeSize * 0.5, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.restore();
                    
                    // ÁªòÂà∂Â¢ûÂº∫Ë°ÄÊù°
                    const barWidth = enemy.width * 1.2;
                    const barHeight = 4;
                    const barX = enemy.x - barWidth / 2;
                    const barY = enemy.y - enemy.height / 2 - 15;
                    
                    // Ë°ÄÊù°Â§ñÊ°Ü
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(barX - 1, barY - 1, barWidth + 2, barHeight + 2);
                    
                    // Ë°ÄÊù°ËÉåÊôØ
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                    ctx.fillRect(barX, barY, barWidth, barHeight);
                    
                    // Ë°ÄÊù°Â°´ÂÖÖÔºàÊ∏êÂèòÊïàÊûúÔºâ
                    const healthPercent = enemy.health / (30 * gameData.difficulty);
                    const healthGradient = ctx.createLinearGradient(barX, barY, barX + barWidth * healthPercent, barY);
                    if (healthPercent > 0.6) {
                        healthGradient.addColorStop(0, '#4caf50');
                        healthGradient.addColorStop(1, '#8bc34a');
                    } else if (healthPercent > 0.3) {
                        healthGradient.addColorStop(0, '#ff9800');
                        healthGradient.addColorStop(1, '#ffc107');
                    } else {
                        healthGradient.addColorStop(0, '#f44336');
                        healthGradient.addColorStop(1, '#e57373');
                    }
                    
                    ctx.fillStyle = healthGradient;
                    ctx.fillRect(barX, barY, barWidth * healthPercent, barHeight);
                    
                    // Ë°ÄÊù°Èó™ÁÉÅÊïàÊûúÔºà‰ΩéË°ÄÈáèÊó∂Ôºâ
                    if (healthPercent < 0.2) {
                        ctx.globalAlpha = 0.5 + Math.sin(Date.now() * 0.01) * 0.5;
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(barX, barY, barWidth * healthPercent, barHeight);
                        ctx.globalAlpha = 1;
                    }
                }
                
                // ÁªòÂà∂Â¢ûÂº∫Áé©ÂÆ∂ÊïàÊûú
                ctx.save();
                
                // Áé©ÂÆ∂Èò¥ÂΩ±
                ctx.shadowColor = 'rgba(255, 152, 0, 0.5)';
                ctx.shadowBlur = 15;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;
                
                // Áé©ÂÆ∂ÂÖâÁéØÊïàÊûú
                const playerTime = Date.now() * 0.005;
                const auraGradient = ctx.createRadialGradient(
                    player.x, player.y, 0,
                    player.x, player.y, player.width * 1.5
                );
                auraGradient.addColorStop(0, 'transparent');
                auraGradient.addColorStop(0.7, player.color.replace(')', ', 0.3)').replace('rgb', 'rgba'));
                auraGradient.addColorStop(1, 'transparent');
                ctx.fillStyle = auraGradient;
                ctx.beginPath();
                ctx.arc(player.x, player.y, player.width * 1.5 + Math.sin(playerTime) * 3, 0, Math.PI * 2);
                ctx.fill();
                
                // ÁªòÂà∂Áé©ÂÆ∂‰∏ª‰ΩìÔºàÂúÜÂΩ¢ÂúüË±ÜÈÄ†ÂûãÔºâ
                const playerGradient = ctx.createRadialGradient(
                    player.x - player.width * 0.3, player.y - player.height * 0.3, 0,
                    player.x, player.y, Math.max(player.width, player.height) / 2
                );
                playerGradient.addColorStop(0, '#ffcc02');
                playerGradient.addColorStop(0.6, player.color);
                playerGradient.addColorStop(1, '#cc7a00');
                
                ctx.fillStyle = playerGradient;
                ctx.beginPath();
                ctx.arc(player.x, player.y, Math.max(player.width, player.height) / 2, 0, Math.PI * 2);
                ctx.fill();
                
                // ÁªòÂà∂Áé©ÂÆ∂ËæπÊ°Ü
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // ÁªòÂà∂Áé©ÂÆ∂ÁúºÁùõ
                ctx.fillStyle = '#ffffff';
                const playerEyeSize = player.width * 0.12;
                ctx.beginPath();
                ctx.arc(player.x - player.width * 0.2, player.y - player.height * 0.15, playerEyeSize, 0, Math.PI * 2);
                ctx.arc(player.x + player.width * 0.2, player.y - player.height * 0.15, playerEyeSize, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#000000';
                ctx.beginPath();
                ctx.arc(player.x - player.width * 0.2, player.y - player.height * 0.15, playerEyeSize * 0.6, 0, Math.PI * 2);
                ctx.arc(player.x + player.width * 0.2, player.y - player.height * 0.15, playerEyeSize * 0.6, 0, Math.PI * 2);
                ctx.fill();
                
                // ÁªòÂà∂Áé©ÂÆ∂Âò¥Â∑¥ - Ê†πÊçÆË°ÄÈáèÊòæÁ§∫‰∏çÂêåË°®ÊÉÖ
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.beginPath();
                
                // Ê£ÄÊü•Ë°ÄÈáèÊòØÂê¶‰Ωé‰∫é‰∏ÄÂçä
                const healthRatio = player.health / player.maxHealth;
                if (healthRatio < 0.5) {
                    // Ë°ÄÈáè‰Ωé‰∫é‰∏ÄÂçäÊó∂ÊòæÁ§∫Âì≠ËÑ∏ÔºàÂêë‰∏ãÂºØÊõ≤ÁöÑÂºßÁ∫øÔºâ
                    ctx.arc(player.x, player.y + player.height * 0.25, player.width * 0.12, Math.PI * 0.2, Math.PI * 0.8);
                    
                    // Ê∑ªÂä†ÁúºÊ≥™ÊïàÊûúÔºàË°ÄÈáèË∂ä‰ΩéË∂äÊòéÊòæÔºâ
                    if (healthRatio < 0.3) {
                        ctx.fillStyle = '#87CEEB';
                        ctx.globalAlpha = 0.7 * (1 - healthRatio);
                        ctx.beginPath();
                        ctx.arc(player.x - player.width * 0.15, player.y + player.height * 0.3, player.width * 0.03, 0, Math.PI * 2);
                        ctx.arc(player.x + player.width * 0.15, player.y + player.height * 0.3, player.width * 0.03, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.globalAlpha = 1;
                    }
                } else {
                    // Ë°ÄÈáèÊ≠£Â∏∏Êó∂ÊòæÁ§∫Á¨ëËÑ∏ÔºàÂêë‰∏äÂºØÊõ≤ÁöÑÂºßÁ∫øÔºâ
                    ctx.arc(player.x, player.y + player.height * 0.1, player.width * 0.15, 0, Math.PI);
                }
                ctx.stroke();
                
                ctx.restore();
                
                // ÁªòÂà∂Â¢ûÂº∫ÂáÜÊòü
                ctx.save();
                const crosshairTime = Date.now() * 0.01;
                const crosshairSize = 12 + Math.sin(crosshairTime) * 2;
                const crosshairAlpha = 0.8 + Math.sin(crosshairTime * 2) * 0.2;
                
                ctx.globalAlpha = crosshairAlpha;
                ctx.strokeStyle = '#ff9800';
                ctx.lineWidth = 3;
                ctx.lineCap = 'round';
                
                // Â§ñÂúà
                ctx.beginPath();
                ctx.arc(mouse.x, mouse.y, crosshairSize + 5, 0, Math.PI * 2);
                ctx.stroke();
                
                // ÂçÅÂ≠óÁ∫ø
                ctx.beginPath();
                ctx.moveTo(mouse.x - crosshairSize, mouse.y);
                ctx.lineTo(mouse.x + crosshairSize, mouse.y);
                ctx.moveTo(mouse.x, mouse.y - crosshairSize);
                ctx.lineTo(mouse.x, mouse.y + crosshairSize);
                ctx.stroke();
                
                // ‰∏≠ÂøÉÁÇπ
                ctx.fillStyle = '#ff9800';
                ctx.beginPath();
                ctx.arc(mouse.x, mouse.y, 2, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.restore();
                
                // ÁªòÂà∂Áä∂ÊÄÅË¶ÜÁõñÂ±Ç
                if (gameState === 'start') {
                    // ÁªòÂà∂ÁÆÄÁ∫¶ËÉåÊôØ
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // ÁªòÂà∂Ê†áÈ¢ò
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = 'bold 42px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('ü•î ÂúüË±ÜÂÖÑÂºü ü•î', canvas.width / 2, canvas.height / 2 - 60);
                    
                    // ÁªòÂà∂ÂºÄÂßãÊåâÈíÆ
                    const buttonX = canvas.width / 2 - 80;
                    const buttonY = canvas.height / 2 + 30;
                    const buttonWidth = 160;
                    const buttonHeight = 50;
                    
                    // ÁÆÄÂçïÊåâÈíÆ
                    ctx.fillStyle = '#4CAF50';
                    ctx.fillRect(buttonX, buttonY, buttonWidth, buttonHeight);
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = 'bold 20px Arial';
                    ctx.fillText('ÂºÄÂßãÊ∏∏Êàè', canvas.width / 2, buttonY + buttonHeight / 2);
                    
                    // Êìç‰ΩúÊèêÁ§∫
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                    ctx.font = '16px Arial';
                    ctx.fillText('ÊåâÁ©∫Ê†ºÈîÆÊàñÁÇπÂáªÊåâÈíÆÂºÄÂßãÊ∏∏Êàè', canvas.width / 2, buttonY + buttonHeight + 30);
                    
                    // Ê∏∏ÊàèËØ¥Êòé
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                    ctx.font = '16px Arial';
                    const instructionsY = buttonY + buttonHeight + 60;
                    if (isMobile) {
                        ctx.fillText('‰ΩøÁî®ËôöÊãüÊëáÊùÜÁßªÂä® ‚Ä¢ Ëá™Âä®ÁûÑÂáÜÊîªÂáªÊïå‰∫∫', canvas.width / 2, instructionsY);
                        ctx.fillText('ÁÇπÂáªÂïÜÂ∫óÊåâÈíÆË¥≠‰π∞ÈÅìÂÖ∑ ‚Ä¢ ÁîüÂ≠òÂ∞ΩÂèØËÉΩÂ§öÁöÑÊ≥¢Ê¨°', canvas.width / 2, instructionsY + 25);
                    } else {
                        ctx.fillText('‰ΩøÁî®WASDÁßªÂä® ‚Ä¢ Ëá™Âä®ÁûÑÂáÜÊîªÂáªÊïå‰∫∫', canvas.width / 2, instructionsY);
                        ctx.fillText('ÊåâEÈîÆÊâìÂºÄÂïÜÂ∫ó ‚Ä¢ ÁîüÂ≠òÂ∞ΩÂèØËÉΩÂ§öÁöÑÊ≥¢Ê¨°', canvas.width / 2, instructionsY + 25);
                    }
                    
                    // Â≠òÂÇ®ÂºÄÂßãÊåâÈíÆÂå∫Âüü‰ø°ÊÅØÁî®‰∫éÁÇπÂáªÊ£ÄÊµã
                    startButton = {
                        x: buttonX,
                        y: buttonY,
                        width: buttonWidth,
                        height: buttonHeight
                    };
                } else if (gameState === 'shop') {
                    // ÂïÜÂ∫óÁïåÈù¢Áé∞Âú®Áî±HTMLÂ§ÑÁêÜÔºåcanvasÂè™ÁªòÂà∂ÂçäÈÄèÊòéËÉåÊôØ
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                } else if (gameState === 'paused') {
                    // ÊöÇÂÅúÁïåÈù¢Áé∞Âú®Áî±HTMLÂ§ÑÁêÜÔºåcanvasÂè™ÁªòÂà∂ÂçäÈÄèÊòéËÉåÊôØ
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                } else if (gameState === 'gameOver') {
                    // Ê∏∏ÊàèÁªìÊùüÁïåÈù¢ - Áé∞‰ª£ÂåñËÆæËÆ°
                    const currentTime = Date.now();
                    const pulseTime = currentTime * 0.002;
                    
                    // ÁªòÂà∂Ê∏êÂèòËÉåÊôØ
                    const bgGradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                    bgGradient.addColorStop(0, 'rgba(139, 0, 0, 0.9)');
                    bgGradient.addColorStop(0.5, 'rgba(178, 34, 34, 0.8)');
                    bgGradient.addColorStop(1, 'rgba(220, 20, 60, 0.9)');
                    ctx.fillStyle = bgGradient;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // ÁªòÂà∂Èó™ÁÉÅÁöÑËæπÊ°ÜÊïàÊûú
                    ctx.strokeStyle = `rgba(255, 255, 255, ${0.5 + Math.sin(pulseTime) * 0.3})`;
                    ctx.lineWidth = 4;
                    ctx.strokeRect(20, 20, canvas.width - 40, canvas.height - 40);
                    
                    // ÁªòÂà∂Ê†áÈ¢ò - Â∏¶ÊúâËÑâÂÜ≤ÊïàÊûú
                    ctx.fillStyle = `rgba(255, 255, 255, ${0.8 + Math.sin(pulseTime * 2) * 0.2})`;
                    ctx.font = 'bold 56px "Arial Black", Arial, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('Ê∏∏ÊàèÁªìÊùü', canvas.width / 2, canvas.height / 2 - 150);
                    
                    // ÁªòÂà∂Ê≠ª‰∫°ÂõæÊ†áÔºàÁ†¥Á¢éÁöÑÂúüË±ÜÔºâ
                    ctx.save();
                    ctx.translate(canvas.width / 2, canvas.height / 2 - 50);
                    ctx.rotate(Math.sin(pulseTime * 0.5) * 0.1);
                    
                    // ÁªòÂà∂Á†¥Á¢éÁöÑÂúüË±Ü‰∏ª‰Ωì
                    ctx.fillStyle = '#8B4513';
                    ctx.beginPath();
                    ctx.arc(0, 0, 30, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // ÁªòÂà∂Ë£ÇÁ∫π
                    ctx.strokeStyle = '#FF6B6B';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(-15, -10);
                    ctx.lineTo(10, 15);
                    ctx.moveTo(10, -15);
                    ctx.lineTo(-5, 20);
                    ctx.stroke();
                    
                    // ÁªòÂà∂ÊÇ≤‰º§ÁöÑÁúºÁùõ
                    ctx.fillStyle = '#FFFFFF';
                    ctx.beginPath();
                    ctx.arc(-10, -5, 5, 0, Math.PI * 2);
                    ctx.arc(10, -5, 5, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#000000';
                    ctx.beginPath();
                    ctx.arc(-10, -5, 2, 0, Math.PI * 2);
                    ctx.arc(10, -5, 2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // ÁªòÂà∂Âì≠ËÑ∏Âò¥Â∑¥
                    ctx.strokeStyle = '#000000';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(0, 8, 8, Math.PI * 0.3, Math.PI * 0.7);
                    ctx.stroke();
                    
                    ctx.restore();
                    
                    // ÁªòÂà∂ÁªüËÆ°‰ø°ÊÅØÂç°Áâá
                    const cardX = canvas.width / 2 - 120;
                    const cardY = canvas.height / 2 + 20;
                    const cardWidth = 240;
                    const cardHeight = 100;
                    
                    // Âç°ÁâáËÉåÊôØ
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    // ÂÖºÂÆπÊÄßÂ§ÑÁêÜÔºöÊâãÂä®ÁªòÂà∂ÂúÜËßíÁü©ÂΩ¢
                    const radius = 15;
                    ctx.moveTo(cardX + radius, cardY);
                    ctx.lineTo(cardX + cardWidth - radius, cardY);
                    ctx.quadraticCurveTo(cardX + cardWidth, cardY, cardX + cardWidth, cardY + radius);
                    ctx.lineTo(cardX + cardWidth, cardY + cardHeight - radius);
                    ctx.quadraticCurveTo(cardX + cardWidth, cardY + cardHeight, cardX + cardWidth - radius, cardY + cardHeight);
                    ctx.lineTo(cardX + radius, cardY + cardHeight);
                    ctx.quadraticCurveTo(cardX, cardY + cardHeight, cardX, cardY + cardHeight - radius);
                    ctx.lineTo(cardX, cardY + radius);
                    ctx.quadraticCurveTo(cardX, cardY, cardX + radius, cardY);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                    
                    // ÁªüËÆ°‰ø°ÊÅØ
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = 'bold 20px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(`ÊúÄÁªàÂàÜÊï∞: ${gameData.score.toLocaleString()}`, canvas.width / 2, cardY + 30);
                    ctx.fillText(`Âà∞ËææÂõûÂêà: ${gameData.wave}`, canvas.width / 2, cardY + 60);
                    
                    // ÁªòÂà∂ÈáçÊñ∞ÂºÄÂßãÊåâÈíÆ
                    const buttonX = canvas.width / 2 - 80;
                    const buttonY = cardY + cardHeight + 30;
                    const buttonWidth = 160;
                    const buttonHeight = 50;
                    
                    // ÊåâÈíÆËÉåÊôØÔºàÂ∏¶ÊÇ¨ÂÅúÊïàÊûúÔºâ
                    const isMouseOverButton = mouse.x >= buttonX && mouse.x <= buttonX + buttonWidth &&
                                           mouse.y >= buttonY && mouse.y <= buttonY + buttonHeight;
                    
                    ctx.fillStyle = isMouseOverButton ? 'rgba(255, 215, 0, 0.8)' : 'rgba(255, 215, 0, 0.6)';
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    // ÂÖºÂÆπÊÄßÂ§ÑÁêÜÔºöÊâãÂä®ÁªòÂà∂ÂúÜËßíÁü©ÂΩ¢
                    const buttonRadius = 10;
                    ctx.moveTo(buttonX + buttonRadius, buttonY);
                    ctx.lineTo(buttonX + buttonWidth - buttonRadius, buttonY);
                    ctx.quadraticCurveTo(buttonX + buttonWidth, buttonY, buttonX + buttonWidth, buttonY + buttonRadius);
                    ctx.lineTo(buttonX + buttonWidth, buttonY + buttonHeight - buttonRadius);
                    ctx.quadraticCurveTo(buttonX + buttonWidth, buttonY + buttonHeight, buttonX + buttonWidth - buttonRadius, buttonY + buttonHeight);
                    ctx.lineTo(buttonX + buttonRadius, buttonY + buttonHeight);
                    ctx.quadraticCurveTo(buttonX, buttonY + buttonHeight, buttonX, buttonY + buttonHeight - buttonRadius);
                    ctx.lineTo(buttonX, buttonY + buttonRadius);
                    ctx.quadraticCurveTo(buttonX, buttonY, buttonX + buttonRadius, buttonY);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                    
                    // ÊåâÈíÆÊñáÂ≠ó
                    ctx.fillStyle = '#000000';
                    ctx.font = 'bold 20px Arial';
                    ctx.fillText('ÈáçÊñ∞ÂºÄÂßã', canvas.width / 2, buttonY + 30);
                    
                    // Êìç‰ΩúÊèêÁ§∫
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                    ctx.font = '16px Arial';
                    if (isMobile) {
                        ctx.fillText('ÂèåÂáªÂ±èÂπïÊàñÁÇπÂáªÊåâÈíÆÈáçÊñ∞ÂºÄÂßã', canvas.width / 2, buttonY + 80);
                    } else {
                        ctx.fillText('ÊåâÁ©∫Ê†ºÈîÆÊàñÁÇπÂáªÊåâÈíÆÈáçÊñ∞ÂºÄÂßã', canvas.width / 2, buttonY + 80);
                    }
                    
                    // Â≠òÂÇ®ÊåâÈíÆÂå∫Âüü‰ø°ÊÅØÁî®‰∫éÁÇπÂáªÊ£ÄÊµã
                    gameOverButton = {
                        x: buttonX,
                        y: buttonY,
                        width: buttonWidth,
                        height: buttonHeight
                    };
                }
            }
            
            // Ê∏∏Êàè‰∏ªÂæ™ÁéØÂèòÈáè
            let lastTime = 0;
            let lastEnemySpawn = 0;
            let isInWaveTransition = false;
            let currentShopPage = 0; // ÂΩìÂâçÂïÜÂ∫óÈ°µÁ†Å
            const messages = [];
            
            // ÊòæÁ§∫Ê∂àÊÅØÂáΩÊï∞
            function showMessage(text, duration) {
                messages.push({
                    text: text,
                    duration: duration,
                    remaining: duration,
                    y: -50
                });
            }
            
            // Êõ¥Êñ∞Ê∂àÊÅØ
            function updateMessages(deltaTime) {
                for (let i = messages.length - 1; i >= 0; i--) {
                    const message = messages[i];
                    message.remaining -= deltaTime;
                    
                    // Ê∂àÊÅØÁßªÂä®Âä®Áîª
                    if (message.y < 80) {
                        message.y += 2 * (deltaTime / 16); // ÂΩí‰∏ÄÂåñÈÄüÂ∫¶
                    }
                    
                    if (message.remaining <= 0) {
                        messages.splice(i, 1);
                    }
                }
            }
            
            // È´òÁ∫ßÈü≥ÊïàÁ≥ªÁªü - ‰ΩøÁî®Web Audio API
            let audioContext;
            let soundCache = new Map();
            
            function initAudio() {
                // ÂàõÂª∫Èü≥È¢ë‰∏ä‰∏ãÊñá
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('Èü≥È¢ëÁ≥ªÁªüÂ∑≤ÂàùÂßãÂåñ');
            }
            
            // ÂàõÂª∫Êõ¥‰∏∞ÂØåÁöÑÈü≥Êïà
            function createSound(type, frequency, duration, volume = 0.3) {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                const filter = audioContext.createBiquadFilter();
                
                // ËÆæÁΩÆÊª§Ê≥¢Âô®
                filter.type = 'lowpass';
                filter.frequency.value = 2000;
                
                // Ê†πÊçÆÈü≥ÊïàÁ±ªÂûãËÆæÁΩÆÂèÇÊï∞
                switch(type) {
                    case 'laser':
                        oscillator.type = 'sawtooth';
                        filter.frequency.value = 1500;
                        break;
                    case 'explosion':
                        oscillator.type = 'square';
                        filter.frequency.value = 800;
                        break;
                    case 'powerup':
                        oscillator.type = 'sine';
                        filter.frequency.value = 3000;
                        break;
                    case 'hit':
                        oscillator.type = 'triangle';
                        filter.frequency.value = 1200;
                        break;
                    default:
                        oscillator.type = 'sine';
                }
                
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                
                oscillator.connect(filter);
                filter.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + duration);
                
                return { oscillator, gainNode, filter };
            }
            
            // Êí≠ÊîæÈü≥ÊïàÂáΩÊï∞
            function playSound(soundType) {
                // Á°Æ‰øùÈü≥È¢ë‰∏ä‰∏ãÊñáÂ∑≤ÂàùÂßãÂåñ
                if (!audioContext) {
                    initAudio();
                }
                
                // ÊÅ¢Â§çÈü≥È¢ë‰∏ä‰∏ãÊñá
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                // Èü≥ÊïàÂèÇÊï∞ÈÖçÁΩÆ
                const soundConfigs = {
                    // Â∞ÑÂáªÈü≥Êïà - ÊøÄÂÖâÊû™Â£∞
                    'shoot': () => createSound('laser', 800, 0.08, 0.2),
                    
                    // Â§öÂºπÈÅìÂ∞ÑÂáªÈü≥Êïà
                    'shootMulti': () => {
                        // ÂàõÂª∫Â§ö‰∏™Èü≥ÊïàÂè†Âä†
                        for (let i = 0; i < 3; i++) {
                            setTimeout(() => {
                                createSound('laser', 600 + i * 100, 0.06, 0.15);
                            }, i * 20);
                        }
                    },
                    
                    // Êïå‰∫∫Âèó‰º§Èü≥Êïà
                    'enemyHit': () => createSound('hit', 300, 0.05, 0.25),
                    
                    // Êïå‰∫∫Ê≠ª‰∫°Èü≥Êïà - Êõ¥‰∏∞ÂØåÁöÑÁàÜÁÇ∏ÊïàÊûú
                    'enemyDeath': () => {
                        // ‰∏ªÁàÜÁÇ∏Èü≥Êïà
                        createSound('explosion', 150, 0.3, 0.4);
                        
                        // Ê∑ªÂä†È´òÈ¢ëÁ¢éÁâáÈü≥Êïà
                        setTimeout(() => {
                            createSound('hit', 600, 0.1, 0.2);
                        }, 50);
                        
                        // Ê∑ªÂä†‰ΩéÈ¢ë‰ΩôÈúá
                        setTimeout(() => {
                            createSound('explosion', 80, 0.2, 0.15);
                        }, 100);
                    },
                    
                    // Áé©ÂÆ∂Âèó‰º§Èü≥Êïà
                    'playerHit': () => createSound('hit', 200, 0.15, 0.4),
                    
                    // Áé©ÂÆ∂Ê≠ª‰∫°Èü≥Êïà
                    'playerDeath': () => {
                        createSound('explosion', 120, 0.8, 0.6);
                        setTimeout(() => {
                            createSound('hit', 300, 0.3, 0.3);
                        }, 200);
                    },
                    
                    // Ê≥¢Ê¨°ÂÆåÊàêÈü≥Êïà
                    'waveComplete': () => {
                        // ËÉúÂà©Èü≥ÊïàÂ∫èÂàó
                        const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
                        notes.forEach((freq, index) => {
                            setTimeout(() => {
                                createSound('powerup', freq, 0.2, 0.3);
                            }, index * 150);
                        });
                    },
                    
                    // Ê≥¢Ê¨°ÂºÄÂßãÈü≥Êïà
                    'waveStart': () => {
                        // Á¥ßÂº†ÁöÑÈü≥ÊïàÂ∫èÂàó
                        const notes = [392, 493.88, 587.33]; // G4, B4, D5
                        notes.forEach((freq, index) => {
                            setTimeout(() => {
                                createSound('laser', freq, 0.15, 0.25);
                            }, index * 100);
                        });
                    },
                    
                    // Ë¥≠‰π∞Èü≥Êïà
                    'purchase': () => {
                        // ÈáëÂ∏ÅÊéâËêΩÈü≥Êïà
                        const notes = [1318.51, 1567.98, 1760]; // E6, G6, A6
                        notes.forEach((freq, index) => {
                            setTimeout(() => {
                                createSound('powerup', freq, 0.1, 0.2);
                            }, index * 80);
                        });
                    },
                    
                    // ÂïÜÂ∫óÊâìÂºÄÈü≥Êïà
                    'shopOpen': () => {
                        // Á•ûÁßòÈü≥Êïà
                        createSound('powerup', 440, 0.3, 0.25);
                        setTimeout(() => {
                            createSound('powerup', 554.37, 0.2, 0.2);
                        }, 150);
                    },
                    
                    // ÂïÜÂ∫óÂÖ≥Èó≠Èü≥Êïà
                    'shopClose': () => {
                        // ÂÖ≥Èó≠Èü≥Êïà
                        createSound('powerup', 554.37, 0.2, 0.2);
                        setTimeout(() => {
                            createSound('powerup', 440, 0.3, 0.25);
                        }, 150);
                    },
                    
                    // ÁàÜÁÇ∏ËåÉÂõ¥Èü≥Êïà
                    'explosion': () => {
                        createSound('explosion', 120, 0.4, 0.5);
                        // Ê∑ªÂä†Á¢éÁâáÈü≥Êïà
                        for (let i = 0; i < 5; i++) {
                            setTimeout(() => {
                                createSound('hit', 400 + i * 100, 0.1, 0.15);
                            }, i * 30);
                        }
                    },
                    
                    // ÂçáÁ∫ßÈü≥Êïà
                    'levelUp': () => {
                        // ÂçáÁ∫ßÂ∫ÜÁ•ùÈü≥Êïà
                        const notes = [523.25, 659.25, 783.99, 1046.5]; // C5, E5, G5, C6
                        notes.forEach((freq, index) => {
                            setTimeout(() => {
                                createSound('powerup', freq, 0.2, 0.3);
                            }, index * 100);
                        });
                    },
                    
                    // ÁßªÂä®Èü≥Êïà
                    'move': () => createSound('hit', 100, 0.05, 0.1),
                    
                    // ÁïåÈù¢ÁÇπÂáªÈü≥Êïà
                    'uiClick': () => createSound('laser', 300, 0.05, 0.15),
                    
                    // ÈîôËØØÈü≥Êïà
                    'error': () => createSound('hit', 200, 0.2, 0.25)
                };
                
                // Êí≠ÊîæÈü≥Êïà
                if (soundConfigs[soundType]) {
                    try {
                        soundConfigs[soundType]();
                        console.log('Êí≠ÊîæÈü≥Êïà:', soundType);
                    } catch (error) {
                        console.warn('Èü≥ÊïàÊí≠ÊîæÂ§±Ë¥•:', soundType, error);
                    }
                } else {
                    console.warn('Êú™Áü•Èü≥ÊïàÁ±ªÂûã:', soundType);
                }
            }
            
            // ËÉåÊôØÈü≥‰πêÁ≥ªÁªü
            let backgroundMusic = null;
            let musicGain = null;
            
            function playBackgroundMusic() {
                if (!audioContext) {
                    initAudio();
                }
                
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                // ÂàõÂª∫ËÉåÊôØÈü≥‰πêÊåØËç°Âô®
                backgroundMusic = audioContext.createOscillator();
                musicGain = audioContext.createGain();
                const filter = audioContext.createBiquadFilter();
                
                // ËÆæÁΩÆÈü≥‰πêÂèÇÊï∞
                backgroundMusic.type = 'sine';
                backgroundMusic.frequency.setValueAtTime(220, audioContext.currentTime); // A3
                musicGain.gain.setValueAtTime(0.1, audioContext.currentTime); // ËæÉ‰ΩéÈü≥Èáè
                filter.type = 'lowpass';
                filter.frequency.value = 1000;
                
                // ÂàõÂª∫ÁÆÄÂçïÁöÑËÉåÊôØÈü≥‰πêÊ®°Âºè
                let time = audioContext.currentTime;
                const notes = [261.63, 329.63, 392, 493.88]; // C4, E4, G4, B4
                let noteIndex = 0;
                
                // ÊØè2ÁßíÂàáÊç¢Èü≥Á¨¶
                setInterval(() => {
                    if (backgroundMusic) {
                        const currentNote = notes[noteIndex];
                        backgroundMusic.frequency.setValueAtTime(currentNote, time);
                        noteIndex = (noteIndex + 1) % notes.length;
                        time += 2.0;
                    }
                }, 2000);
                
                backgroundMusic.connect(filter);
                filter.connect(musicGain);
                musicGain.connect(audioContext.destination);
                
                backgroundMusic.start();
                
                console.log('ËÉåÊôØÈü≥‰πêÂ∑≤ÂêØÂä®');
            }
            
            function stopBackgroundMusic() {
                if (backgroundMusic) {
                    backgroundMusic.stop();
                    backgroundMusic = null;
                    console.log('ËÉåÊôØÈü≥‰πêÂ∑≤ÂÅúÊ≠¢');
                }
            }
            
            function setMusicVolume(volume) {
                if (musicGain) {
                    musicGain.gain.setValueAtTime(volume, audioContext.currentTime);
                }
            }
            
            // ÂàõÂª∫ÁàÜÁÇ∏ÊïàÊûú
            function createExplosion(x, y, radius) {
                // ÂàõÂª∫ÁàÜÁÇ∏Á≤íÂ≠ê
                for (let i = 0; i < 20; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = Math.random() * 3 + 1;
                    const size = Math.random() * 4 + 2;
                    
                    particles.push({
                        x: x,
                        y: y,
                        size: size,
                        vx: Math.cos(angle) * speed,
                        vy: Math.sin(angle) * speed,
                        life: Math.random() * 0.5 + 0.5,
                        color: '#ff9800'
                    });
                }
            }
            
            // ÁªòÂà∂Ê∂àÊÅØ
            function drawMessages() {
                for (const message of messages) {
                    ctx.fillStyle = `rgba(255, 152, 0, ${message.remaining / message.duration})`;
                    ctx.font = '24px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(message.text, canvas.width / 2, message.y);
                }
            }
            
            // Ê∏∏Êàè‰∏ªÂæ™ÁéØ
            function gameLoop(timestamp) {
                if (!lastTime) lastTime = timestamp;
                const deltaTime = timestamp - lastTime;
                lastTime = timestamp;
                
                // ÊÄßËÉΩ‰ºòÂåñÔºöÈôêÂà∂Â∏ßÁéáÔºàÁßªÂä®Á´ØÔºâ
                if (isMobile && deltaTime < 16) {
                    requestAnimationFrame(gameLoop);
                    return;
                }
                
                update();
                
                // È¢ùÂ§ñÁöÑÊ≥¢Ê¨°ËøáÊ∏°ÁªòÂà∂ÈÄªËæë
                if (gameState === 'playing' && isInWaveTransition) {
                    const transitionProgress = timestamp - gameData.waveTimer;
                    if (transitionProgress < gameData.waveTransitionTime) {
                        // ÊòæÁ§∫ËøáÊ∏°‰ø°ÊÅØ
                        const secondsLeft = Math.ceil((gameData.waveTransitionTime - transitionProgress) / 1000);
                        ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = '#ff9800';
                        ctx.font = '36px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(`Á¨¨ ${gameData.wave} Ê≥¢Âç≥Â∞ÜÂºÄÂßã`, canvas.width / 2, canvas.height / 2);
                        ctx.font = '24px Arial';
                        ctx.fillText(`ÂáÜÂ§áÊó∂Èó¥: ${secondsLeft}Áßí`, canvas.width / 2, canvas.height / 2 + 50);
                        ctx.font = '18px Arial';
                        ctx.fillText(`Êïå‰∫∫Êï∞Èáè: ${gameData.enemiesPerWave}`, canvas.width / 2, canvas.height / 2 + 90);
                    }
                }
                
                render();
                
                // Êõ¥Êñ∞HTMLÂÄíËÆ°Êó∂ÊòæÁ§∫
                if (gameState === 'playing' && gameData.waveStartTime > 0) {
                    const now = Date.now();
                    const waveElapsedTime = now - gameData.waveStartTime;
                    const timeLeft = Math.max(0, gameData.waveDuration - waveElapsedTime);
                    const minutes = Math.floor(timeLeft / 60000);
                    const seconds = Math.floor((timeLeft % 60000) / 1000);
                    const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    // Êõ¥Êñ∞HTMLÂÖÉÁ¥†
                    const waveTimerElement = document.getElementById('waveTimer');
                    if (waveTimerElement) {
                        waveTimerElement.textContent = `Á¨¨${gameData.wave}Ê≥¢Ââ©‰ΩôÊó∂Èó¥: ${formattedTime}`;
                    }
                } else {
                    // ÈùûÊ∏∏ÊàèÁä∂ÊÄÅÊó∂ÈöêËóèÊàñÊòæÁ§∫ÈªòËÆ§ÂÄº
                    const waveTimerElement = document.getElementById('waveTimer');
                    if (waveTimerElement) {
                        waveTimerElement.textContent = `Á¨¨${gameData.wave}Ê≥¢Ââ©‰ΩôÊó∂Èó¥: ÂáÜÂ§á‰∏≠...`;
                    }
                }
                
                // Êõ¥Êñ∞ÂíåÁªòÂà∂Ê∂àÊÅØ
                updateMessages(deltaTime);
                drawMessages();
                
                // ÊÄßËÉΩÁõëÊéßÔºàÂºÄÂèëÊ®°ÂºèÔºâ
                if (window.DEBUG_MODE) {
                    const fps = Math.round(1000 / deltaTime);
                    ctx.fillStyle = '#ffffff';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'left';
                    ctx.fillText(`FPS: ${fps} | Êïå‰∫∫: ${enemies.length} | Á≤íÂ≠ê: ${particles.length}`, 10, 20);
                }
                
                requestAnimationFrame(gameLoop);
            }
            
            // ÂêØÂä®Ê∏∏Êàè
            init();
            updateUI();
        });
    </script>
</body>
</html>